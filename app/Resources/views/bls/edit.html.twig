{% extends 'baseAdmin.html.twig' %}
{% block body %}
    <style>
        body{
            background: white;
        }
        .aa{
            padding: 1.5rem;
            margin-right: 0;
            margin-bottom: 0;
            margin-left: 0;
            border: solid 1px #dddddd;

        }
        #1 option[label]{
            float: left;
            color: red;
        }
        .panel-success>.panel-heading{
            background: linear-gradient(to bottom, #fff 0%, #f6f6f6 19%, #ededed 100%);
            border-color: #dddddd;
            color: #000;
        }
        .panel-success {
            border-color: #dddddd;

        }
        .panel-title{
            font-size: 12px;
        }
        .forms{
            margin-bottom: 10px;
        }

        .fa-close{
            -webkit-border-radius: 100px;
            font-size: 1.1em;
            color: white;
            border-radius: 100px;
            line-height: 0.9em;
            padding: 5px 6px;
            margin-top: 20px;
            cursor: pointer;
            background: linear-gradient(to bottom, #f85032 0%, #f16f5c 19%, #f6290c 55%, #f02f17 71%, #e73827 100%);
        }
        .del {
            position: absolute;
            float: right;
            margin-top: 4px;
            margin-right: -19px;
            left: 91%;
        }
        form .row{
            margin-bottom: 0;
        }
        .main-spinner {

            height: 6px;
            left: -10px;
            margin: 0;
            position: fixed;
            right: -3px;
            width: 103%;
            z-index: 99;
            top: 38px;
            max-width: 103%;
        }
        .progress {
            overflow: hidden;
            height: 18px;
            margin-bottom: 20px;
            background-color: #f5f5f5;
            border-radius: 4px;
            -webkit-box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.1);
        }
        .progress-bar {
            float: left;
            width: 0%;
            height: 100%;
            font-size: 12px;
            color: #ffffff;
            text-align: center;
            background-color: #428bca;
            -webkit-box-shadow: inset 0 -1px 0 rgba(0,0,0,0.15);
            box-shadow: inset 0 -1px 0 rgba(0,0,0,0.15);
            -webkit-transition: width 0.6s ease;
            transition: width 0.6s ease;
        }
        .progress-striped .progress-bar {
            background-image: linear-gradient(45deg, rgba(255,255,255,0.15) 25%, transparent 25%, transparent 50%, rgba(255,255,255,0.15) 50%, rgba(255,255,255,0.15) 75%, transparent 75%, transparent);
            background-size: 40px 40px;
        }
        .progress.active .progress-bar, .progress-bar.active {
            -webkit-animation: progress-bar-stripes 2s linear infinite;
            -o-animation: progress-bar-stripes 2s linear infinite;
            animation: progress-bar-stripes 0.2s linear infinite;
        }
        textarea.acheteur {
            height: 32px;
        }
        .acheteur_id{
            display: none;
        }
        #seller_tip {
            margin-right: 5px;
            padding-right: 20px;
        }
        .alert-sm {
            padding: 2px 5px;
            display: block;
            position: relative;
            margin-bottom: 5px;
        }
        .alert-warning {
            background-color: #fcf8e3;
            border-color: #fbeed5;
            color: #c09853;
        }
        .alert-sm .close {
            position: absolute;
            top: -1px;
            color: red;
            right: 3px;
        }
        .close:hover, .close:focus {
            color: #000000;
            text-decoration: none;
            cursor: pointer;
            opacity: 0.5;
            filter: alpha(opacity=50);
        }
        .small-alert {
            padding: 4px 10px 2px 10px;
            margin-bottom: 0;
        }
        .alert-info {
            background-color: #d9edf7;
            border-color: #bce8f1;
            color: #3a87ad;
        }
        .description{
            margin-top: 10px;
            margin-bottom: 10px;
            max-width: 100%;
            min-height: 5em;
        }
        .list-group-item.active>div>.btn-glow, #form1 .list-group-item.active>div>a, #form1 .list-group-item.active>a {
            font-size: 0.9em;
            color: #000;
            text-decoration: none;
        }
        .list-group-item.active .pull-right {
            margin: -2px -8px 0 0;
        }
        .pull-right {
            float: right !important;
        }
        #show_discount_button{
            border-radius: 3px;
            font-size: 0.9em;
            margin-right: 5px;
            color: #000;
            padding: 2px 7px;
            text-decoration: none;
            margin-top: -52px;

        }
        #details>div, #form1 .row {
            position: relative;
        }
        html .help_sign {
            background: #fff;
            border-radius: 10px;
            -webkit-border-radius: 10px;
            -moz-border-radius: 10px;
            color: #bbbbbb;
            font-size: 0.8em;
            height: 16px;
            width: 16px;
            display: inline-block;
            line-height: 1.2em;
            padding-top: 2px;
            text-align: center;
            text-decoration: none;
            border: 1px solid #dcdcdc;
        }
        .tooltip_templates { display: none; }

        h2 {
            font-size: 20px;
            color: #696d73;
            font-style: italic;
        }
        .description {
            margin-top: 0px;
            margin-bottom: 10px;
            max-width: 100%;
            min-height: 0;
            height: 34px !important;
        }
        .panel-body span{
            font-weight: bold;
        }
        .panel-body {
            padding: 15px;
            padding-left: 0;
            padding-right: 0;
        }
        .del{
            z-index: 9;
        }
        .champ1, .champ2, .champ3, .champ4, .champ5, .champ6, .champ7 ,.champ8 ,.champ9  {
            margin-top: 1px;
            margin-bottom: 18px;
        }
        .champ10{
            margin-top: 16px;
        }
        .btn-glow {
            font-size: 13px;
        }
    </style>

    <div class="container">
        <div class="form1">

            {{ form_start(edit_form) }}

            <div class="row">
                <div class="col-sm-12">
                    <h2 style="color: #29323d;">Documents de gestion de stock</h2>
                </div>
                <div class="col-sm-5">

                    {{ form_label(edit_form.type, "Type ") }} <span class="requis">*</span>
                    {{ form_widget(edit_form.type,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.type) }}
                </div>
                <div class=" col-sm-4 col-xs-6 ">

                    {{ form_label(edit_form.nf, "N° ") }} <span class="requis">*</span>


                        {{ form_widget(edit_form.nf,{'attr': {'class': 'form-control'}}) }}
                        {{ form_errors(edit_form.nf) }}




                </div>
                <div class="col-sm-2 ">

                    {{ form_label(edit_form.dateadd, "Date d'entrée ") }}
                    {{ form_widget(edit_form.dateadd,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.dateadd) }}
                </div>
                <div class="col-sm-4 col-xs-6">

                    {{ form_label(edit_form.zonnestocks, "Entrepôt") }} <span class="requis">*</span>
                    {{ form_widget(edit_form.zonnestocks,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.zonnestocks) }}
                </div>

            </div>
            <hr>



            <div class="row ">

                <div class="col-md-5 col-sm-12 col-xs-12  ">
                    <h2>Fournisseur </h2>
                    <div class="tooltip_templates">
                        <span id="help_vendeur">
                     <p>
• Pour ajouter un <strong>logo</strong> sur vos documents, allez dans les <a >Paramètres d'impression</a>.<br>
• Pour renseigner les&nbsp;<strong>mentions légales</strong> (qui&nbsp;<span style="line-height: 20.7999992370605px;">apparaîtront en bas de page de vos documents)</span>&nbsp;allez dans&nbsp;<a>Paramètres &gt; Compagnies/Départements</a>.<br>
<a >En savoir plus</a>&nbsp;</p>


                        </span>
                    </div>
                    <div class="departement_view " style="">
                    </div>

                    <div class="departement_form " style=" display: none;">
                        {% if departements == null %}
                            <span class="alert alert-warning alert-sm" id="seller_tip" title="Les données indiquées sont mémorisées dans la fiche de votre entreprise (ou &quot;Département&quot;) que vous pourrez compléter ou modifier depuis Paramètres > Compagnies/Départements.">
					Les données indiquées seront mémorisées dans la fiche de votre entreprise accessible dans Paramètres &gt; Compagnies/Départements.
					<a href="#" onclick="$('#seller_tip').fadeOut();return false;" class="close" title="Cacher l'indication">x</a>
				</span>
                        {% endif %}

                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                                {{ form_widget(edit_form.departements.user,{'attr': {'class': 'form-control departement_user hidden'}}) }}
                                {{ form_errors(edit_form.departements.user) }}

                                {{ form_label(edit_form.departements.id, " ") }} <span class="requis"> </span>
                                {{ form_widget(edit_form.departements.id,{'attr': {'class': 'form-control departement_id'}}) }}
                                {{ form_errors(edit_form.departements.id) }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.nom, "Nom") }} <span class="requis">*</span>
                                {{ form_widget(edit_form.departements.nom,{'attr': {'class': 'form-control departement_nom'}}) }}
                                {{ form_errors(edit_form.departements.nom) }}


                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.nrcselect, " ") }}
                                {{ form_widget(edit_form.departements.nrcselect,{'attr': {'class': 'form-control departement_nrcselect'}}) }}
                                {{ form_errors(edit_form.departements.nrcselect) }}
                            </div>
                            <div class="col-md-8 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.nrc, " ") }}
                                {{ form_widget(edit_form.departements.nrc,{'attr': {'class': 'form-control departement_nrc'}}) }}
                                {{ form_errors(edit_form.departements.nrc) }}

                                {{ form_widget(edit_form.departements.nif,{'attr': {'class': 'form-control departement_nif'}}) }}
                                {{ form_errors(edit_form.departements.nif) }}
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.adresse, "N° et nom de rue") }}
                                {{ form_widget(edit_form.departements.adresse,{'attr': {'class': 'form-control departement_adresse'}}) }}
                                {{ form_errors(edit_form.departements.adresse) }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-4 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.codepostal, "Code postal") }}
                                {{ form_widget(edit_form.departements.codepostal,{'attr': {'class': 'form-control departement_codepostal'}}) }}
                                {{ form_errors(edit_form.departements.codepostal) }}
                            </div>
                            <div class="col-md-8 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.departements.ville, "Ville") }}
                                {{ form_widget(edit_form.departements.ville,{'attr': {'class': 'form-control departement_ville'}}) }}
                                {{ form_errors(edit_form.departements.ville) }}
                            </div>
                        </div>


                        <div class="row">

                            <div class="col-md-12 col-sm-12 col-xs-12 form-group">

                                <button class="btn pull-right btn-link btn-xs dropdown-toggle" type="button" data-toggle="dropdown" id="show_more2" onclick="$('#more2').fadeIn('fast');$('#show_more2').hide();return false;" style="display: block;">
                                    Plus  <span class="caret"></span>
                                </button>

                            </div>

                        </div>
                        <div id="more2" class="more" style="display: block;">
                            <div class="row">
                                <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.iban, "IBAN") }}
                                    {{ form_widget(edit_form.departements.iban,{'attr': {'class': 'form-control departement_iban'}}) }}
                                    {{ form_errors(edit_form.departements.iban) }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.banque, "Banque") }}
                                    {{ form_widget(edit_form.departements.banque,{'attr': {'class': 'form-control departement_banque'}}) }}
                                    {{ form_errors(edit_form.departements.banque) }}
                                </div>
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.bic, "BIC") }}
                                    {{ form_widget(edit_form.departements.bic,{'attr': {'class': 'form-control departement_bic'}}) }}
                                    {{ form_errors(edit_form.departements.bic) }}
                                </div>


                            </div>

                            <div class="row">
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.email, "Adresse email") }}
                                    {{ form_widget(edit_form.departements.email,{'attr': {'class': 'form-control departement_email'}}) }}
                                    {{ form_errors(edit_form.departements.email) }}
                                </div>
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.siteweb, "Site web") }}
                                    {{ form_widget(edit_form.departements.siteweb,{'attr': {'class': 'form-control departement_site'}}) }}
                                    {{ form_errors(edit_form.departements.siteweb) }}
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.fax, "Fax") }}
                                    {{ form_widget(edit_form.departements.fax,{'attr': {'class': 'form-control departement_fax'}}) }}
                                    {{ form_errors(edit_form.departements.fax) }}
                                </div>
                                <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                    {{ form_label(edit_form.departements.telephone, "Téléphone") }}
                                    {{ form_widget(edit_form.departements.telephone,{'attr': {'class': 'form-control departement_tel'}}) }}
                                    {{ form_errors(edit_form.departements.telephone) }}
                                </div>
                            </div>
                            <button class="btn pull-right btn-link btn-xs dropdown-toggle" type="button" data-toggle="dropdown" id="show_more2" onclick="$('#more2').hide();$('#show_more2').fadeIn('fast');return false;">
                                Moins <i class="icon-sort-up"></i>
                            </button>

                        </div>
                    </div>


                </div>
                <div class="col-md-2 col-sm-12 col-xs-12 form-group">
                </div>
                <div class="col-md-5 col-sm-12 col-xs-12 form-group">

                    <h2>Client</h2>
                    {% if acheteursList == null %}
                        <span class="alert alert-warning alert-sm" id="buyer_tip" title="Une fois le contact ajouté, il suffira de taper une ou deux lettres de son nom (ou de son n° de TVA par ex) pour le sélectionner. ">
					Après avoir saisi les coordonnées d'un nouveau client ou fournisseur, celui-ci sera ajouté automatiquement à la liste de vos Contacts.
					<a href="#" onclick="$('#buyer_tip').fadeOut();return false;" class="close" title="Cacher l'indication">x</a>
				</span>
                    {% endif %}
                    <div class="row">
                        <div class="col-sm-6">
                            <div class="checkbox" style="width: 567px;">

                                {{ form_widget(edit_form.acheteur.type,{'attr': {'class': 'acheteur_type'}}) }}
                                {{ form_errors(edit_form.acheteur.type) }}
                            </div>
                        </div>
                    </div>
                    <div class="row particulier" style="display: none;">
                        <div class="col-sm-2">
                            {{ form_label(edit_form.acheteur.civilite, "Civilité") }}
                            {{ form_widget(edit_form.acheteur.civilite,{'attr': {'class': 'form-control acheteur_civilite'}}) }}
                            {{ form_errors(edit_form.acheteur.civilite) }}
                        </div>
                        <div class="col-sm-4">
                            {{ form_label(edit_form.acheteur.prenom, "Prénom") }}
                            {{ form_widget(edit_form.acheteur.prenom,{'attr': {'class': 'form-control acheteur_prenom'}}) }}
                            {{ form_errors(edit_form.acheteur.prenom) }}
                        </div>
                        <div class="col-sm-6">
                            {{ form_label(edit_form.acheteur.famille, "Nom de famille") }}
                            {{ form_widget(edit_form.acheteur.famille,{'attr': {'class': 'form-control acheteur_famille'}}) }}
                            {{ form_errors(edit_form.acheteur.famille) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                            {{ form_widget(edit_form.acheteur.user,{'attr': {'class': 'form-control hidden acheteur_user'}}) }}
                            {{ form_errors(edit_form.acheteur.user) }}

                            {{ form_widget(edit_form.acheteur.id,{'attr': {'class': 'form-control acheteur acheteur_id','autocomplete': 'off'}}) }}

                            {{ form_label(edit_form.acheteur.nom, "Nom") }} <span class="requis nomrequis">*</span>
                            {{ form_widget(edit_form.acheteur.nom,{'attr': {'class': 'form-control acheteur acheteur_nom','autocomplete': 'off'}}) }}
                            {{ form_errors(edit_form.acheteur.nom) }}
                            <div id="acheteur" style="position: relative;z-index: 999;margin-top: 11px;margin-left: -4px;width: 100%; border: none;"></div>
                            <a style="top: 30px;" class="autocomplete_vendeur" >▼</a>
                        </div>
                    </div>
                    <div class="row nif">
                        <div class="col-md-4 col-sm-12 col-xs-12 form-group">

                            {{ form_widget(edit_form.acheteur.nrcselect,{'attr': {'class': 'form-control acheteur_nrcselect'}}) }}
                            {{ form_errors(edit_form.acheteur.nrcselect) }}
                        </div>
                        <div class="col-md-8 col-sm-12 col-xs-12 form-group">

                            {{ form_widget(edit_form.acheteur.nrc,{'attr': {'class': 'form-control acheteur_nrc'}}) }}
                            {{ form_errors(edit_form.acheteur.nrc) }}

                            {{ form_widget(edit_form.acheteur.nif,{'attr': {'class': 'form-control acheteur_nif'}}) }}
                            {{ form_errors(edit_form.acheteur.nif) }}

                        </div>
                    </div>


                    <div class="row">
                        <div class="col-md-12 col-sm-12 col-xs-12 form-group">
                            {{ form_label(edit_form.acheteur.adresse, "N° et nom de rue") }}
                            {{ form_widget(edit_form.acheteur.adresse,{'attr': {'class': 'form-control acheteur_adresse'}}) }}
                            {{ form_errors(edit_form.acheteur.adresse) }}
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4 col-sm-12 col-xs-12 form-group">
                            {{ form_label(edit_form.acheteur.codepostal, "Code postal") }}
                            {{ form_widget(edit_form.acheteur.codepostal,{'attr': {'class': 'form-control acheteur_codepostal'}}) }}
                            {{ form_errors(edit_form.acheteur.codepostal) }}
                        </div>
                        <div class="col-md-8 col-sm-12 col-xs-12 form-group">
                            {{ form_label(edit_form.acheteur.ville, "Ville") }}
                            {{ form_widget(edit_form.acheteur.ville,{'attr': {'class': 'form-control acheteur_ville'}}) }}
                            {{ form_errors(edit_form.acheteur.ville) }}
                        </div>
                    </div>
                    <div class="row">

                        <div class="col-md-12 col-sm-12 col-xs-12 form-group">

                            <button class="btn pull-right btn-link btn-xs dropdown-toggle" type="button" data-toggle="dropdown" id="show_more3" onclick="$('#more3').fadeIn('fast');$('#show_more3').hide();return false;" style="display: block;">
                                Plus  <span class="caret"></span>
                            </button>

                        </div>

                    </div>
                    <div id="more3" class="more" style="display: block;">
                        <div class="row">
                            <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.acheteur.email, "Adresse email") }}
                                {{ form_widget(edit_form.acheteur.email,{'attr': {'class': 'form-control acheteur_email'}}) }}
                                {{ form_errors(edit_form.acheteur.email) }}
                            </div>
                            <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.acheteur.siteweb, " Site internet") }}
                                {{ form_widget(edit_form.acheteur.siteweb,{'attr': {'class': 'form-control acheteur_site'}}) }}
                                {{ form_errors(edit_form.acheteur.siteweb) }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.acheteur.fax, "Fax") }}
                                {{ form_widget(edit_form.acheteur.fax,{'attr': {'class': 'form-control acheteur_fax'}}) }}
                                {{ form_errors(edit_form.acheteur.fax) }}
                            </div>
                            <div class="col-md-6 col-sm-12 col-xs-12 form-group">
                                {{ form_label(edit_form.acheteur.telephone, " Téléphone") }}
                                {{ form_widget(edit_form.acheteur.telephone,{'attr': {'class': 'form-control acheteur_tel'}}) }}
                                {{ form_errors(edit_form.acheteur.telephone) }}
                            </div>

                        </div>
                        <button class="btn pull-right btn-link btn-xs dropdown-toggle" type="button" data-toggle="dropdown" id="show_more2" onclick="$('#more3').hide();$('#show_more3').fadeIn('fast');return false;">
                            Moins <i class="icon-sort-up"></i>
                        </button>
                    </div>

                </div>
            </div>

            <div class="row">
                <hr>
                <div class="col-sm-4">
                    {{ form_label(edit_form.editerpar, "Edité par") }}
                    {{ form_widget(edit_form.editerpar,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.editerpar) }}
                </div>
                <div class="col-sm-4">
                    {{ form_label(edit_form.expedierpar, "Expédié par") }}
                    {{ form_widget(edit_form.expedierpar,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.expedierpar) }}
                </div>
                <div class="col-sm-4">
                    {{ form_label(edit_form.receptionnerpar, "Réceptionné par") }}
                    {{ form_widget(edit_form.receptionnerpar,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.receptionnerpar) }}
                </div>

            </div>
            <div class="row">
                <div class="col-sm-12 col-xs-12 ">
                    {{ form_label(edit_form.informations, "Commentaires") }}
                    {{ form_widget(edit_form.informations,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.informations) }}
                </div>
            </div>
            <div class="row">
                <div class="col-sm-2">

                    {{ form_label(edit_form.datecreation, "Date de création ") }}
                    {{ form_widget(edit_form.datecreation,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.datecreation) }}
                </div>
                <div class="col-sm-2">

                    {{ form_label(edit_form.ncommande, "Numéro de la commande") }}
                    {{ form_widget(edit_form.ncommande,{'attr': {'class': 'form-control'}}) }}
                    {{ form_errors(edit_form.ncommande) }}
                </div>


            </div>
            <div class="row">
                <div class="col-sm-7"></div>
                <div class="col-sm-5">
                    <br>

                    <div class="alert alert-info row">
                        Le prix d'achat est automatiquement rempli en conformité avec les paramètres de gestion de stock (ordre de sortie)
                        :
                        FIFO (les premiers produits qui entrent en stock sont les premiers qui en sortent)


                    </div>

                </div>
            </div>

            <br> <br>
            <div class="panel panel-success">
                <div class="panel-heading">
                    <h3 class="panel-title"><strong>Produits</strong></h3>
                </div>


                <div class="panel-body">


                    {% macro tagCollectionItem(ventes) %}



                        <div class="row forms {{ ventes.vars.id }}">
                            <hr>
                            <div id="change" class="product{{ ventes.vars.id }} col-md-4">

                                <span style="font-size: 12px;"> Produit</span> <span style="color: red;">*</span>

                                {{ form_widget(ventes.name,{'attr': {'class': 'form-control champ1', 'autocomplete':'off'}}) }}
                                {{ form_widget(ventes.produits,{'attr': {'class': 'form-control produits hidden'}}) }}
                                {{ form_widget(ventes.user,{'attr': {'class': 'form-control produits hidden'}}) }}

                            </div>


                            <div class="col-md-1">
                                <span style="font-size: 12px;"> Référence</span>

                                {{ form_widget(ventes.reference,{'attr': {'class': 'form-control REF champ2'}}) }}
                            </div>

                            <div class="col-md-1">
                                <span style="font-size: 12px;">Quantité</span> <span style="color: red;">*</span>

                                {{ form_widget(ventes.qte,{'attr': {'class': 'form-control QTE champ3'}}) }}
                            </div>
                            <div class="col-md-1">
                                <span style="font-size: 12px;">Unité</span>

                                {{ form_widget(ventes.unite,{'attr': {'class': 'form-control unite champ4'}}) }}
                            </div>
                            <div class="col-md-1">
                                <span style="font-size: 12px;"> Taxe % (achat)</span>

                                {{ form_widget(ventes.tva,{'attr': {'class': 'form-control TVA champ5'}}) }}

                            </div>
                            <div class="col-md-1">
                                <span style="font-size: 12px;"> Prix HT (vente)</span> <span style="color: red;">*</span>
                                {{ form_widget(ventes.puHT,{'attr': {'class': 'form-control puHT champ6'}}) }}
                            </div>
                            <div class="col-md-1">
                                <span style="font-size: 12px;"> Prix TTC (vente)</span>
                                {{ form_widget(ventes.puTTC,{'attr': {'class': 'form-control puTTC champ7'}}) }}
                            </div>

                            <div class="col-md-1">
                                <span style="font-size: 12px;">Total HT (vente)</span>
                                {{ form_widget(ventes.totalHT,{'attr': {'class': 'form-control totalHT champ8'}}) }}
                            </div>
                            <div class="col-md-1">
                                <span style="font-size: 12px;">Total TTC (vente)</span>
                                {{ form_widget(ventes.totalTTC,{'attr': {'class': 'form-control totalTTC champ9'}}) }}
                            </div>

                            <div class="row">
                                <div  class="part2_{{ ventes.vars.id }}">
                                    <div class="col-xs-9 col-sm-5">
                                        <span style="font-size: 12px;">Commentaire</span>
                                        {{ form_widget(ventes.description,{'attr': {'class': 'form-control description','rows':10}}) }}
                                    </div>

                                    <div class="col-sm-2"></div>



                                    <div class="col-xs-3 col-sm-1">
                                        <span style="font-size: 12px;"> Taxe</span>
                                        {{ form_widget(ventes.tva2,{'attr': {'class': 'form-control TVA2'}}) }}
                                    </div>

                                    <div class="col-xs-6 col-sm-1 required">
                                        <span style="font-size: 12px;"> Prix HT</span> <span style="color: red;">*</span>
                                        {{ form_widget(ventes.prixHT,{'attr': {'class': 'form-control prixHT'}}) }}
                                    </div>

                                    <div class="col-xs-6 col-sm-1">
                                        <span style="font-size: 12px;"> Prix TTC</span>
                                        {{ form_widget(ventes.prixTTC,{'attr': {'class': 'form-control prixTTC'}}) }}
                                    </div>

                                    <div class="col-xs-6 col-sm-1">
                                        <span style="font-size: 12px;">Total HT</span>
                                        {{ form_widget(ventes.totalHTa,{'attr': {'class': 'form-control totalHTa'}}) }}
                                    </div>

                                    <div class="col-xs-6 col-sm-1">
                                        <span style="font-size: 12px;">Total TTC</span>
                                        {{ form_widget(ventes.totalTTCa,{'attr': {'class': 'form-control totalTTCa '}}) }}
                                    </div>
                                </div>
                                <span></span>
                                <button class="btn pull-right btn-link btn-xs dropdown-toggle show_part2_{{ ventes.vars.id }}" type="button" data-toggle="dropdown" id="show_more2" onclick="$('#more2').fadeIn('fast');$('#show_more2').hide();return false;" style="display: block;">
                                    Prix (vente)  <span class="caret"></span>
                                </button>
                                <button id="" class="pull-right btn btn-link btn-xs dropdown-toggle hide_part2_{{ ventes.vars.id }}" type="button" data-toggle="dropdown">
                                    Cacher <i class="fa fa-sort-up"></i>
                                </button>
                            </div>
                            {{ form_widget(ventes.reduction,{'attr': {'class': 'form-control hidden reduction'}}) }}
                            {{ form_widget(ventes,{'attr': {'class': 'form-control hidden '}}) }}

                        </div>
                    {% endmacro %}


                    <div class="tags" data-prototype="{{ _self.tagCollectionItem(edit_form.ventes.vars.prototype)|e }}">
                        {% for ventes in edit_form.ventes %}
                            {{ _self.tagCollectionItem(ventes) }}

                        {% endfor %}


                    </div>




                </div>
            </div>


            <div class="row">

                <div class="invoice_summary col-sm-4 col-sm-offset-8">
                    <table class="table">
                        <tbody><tr class="curr_s netto ">
                            <th>Total HT</th>
                            <td id="sum_net"> </td>
                            <td style="width:1%;" class="_curr1">DA</td>
                            <td>
                                <div class="dropdown mini_dropdown">
                                    <a class="dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                        <span class="caret"></span>
                                    </a>
                                    <ul class="dropdown-menu" role="menu" aria-labelledby="dLabel">
                                        <li><a href="javascript:show_select_currency();">Changer de devise</a></li>
                                    </ul>
                                </div>
                            </td>
                        </tr>

                        <tr class="curr_s ">
                            <th>Total TVA</th>

                            <td id="sum_tva"> </td>
                            <td class="_curr1"> DA</td>
                            <td></td>
                        </tr>

                        <tr class="curr_s more_discount1 hidden" style="display: none;">
                            <th class="">Réduction</th>
                            <td class="" id="sum_discount">0,00</td>
                            <td class="_curr1"> DA</td>
                            <td>

                            </td>
                        </tr>

                        <tr class="curr_s">
                            <th class="bold">Total TTC</th>
                            <td id="sum_ttc" class="bold"> </td>
                            <td class="_curr1">
                                DA
                            </td>
                            <td>

                            </td>
                        </tr>

                        <tr class="curr_s more_discount1 hidden" >
                            <th class="bold ">Total TTC après réductions</th>
                            <td id="sum_after_discount" class="bold "></td>
                            <td class="_curr1"> DA</td>
                        </tr>



                        </tbody></table>



                </div> <!-- invoice_summary -->

            </div>



            <hr style="border-top: 1px solid #ddd;">
            <button type="submit" class="btn-glow primary " style="margin-left:5px;"><span class="glyphicon glyphicon-saved" aria-hidden="true"></span> Sauvegarder</button> ou <a href="{{ path('admin_bes_index') }}">Annuler</a>


            {{ form_rest(edit_form) }}
            {{ form_end(edit_form) }}
        </div>
    </div>
    <br> <br> <br>
    <script type="text/javascript" src="{{ asset('js/jquery.js') }}"></script>




    <script>
        var loader = "{{ asset('image/ajax-loader-wide.gif') }}"; //link to the animated loader-small.gif
        var ROOT_URL = "{{ url('admin_depenses_getAllprods')}}";
        var ROOT_URL2 = "{{ url('admin_depenses_getAcheteur')}}";

    </script>

    <script type="text/javascript">

        $('.acheteur_nom,.autocomplete_vendeur').hover(

            function () {
                $('.autocomplete_vendeur').css( "color", "#000" );
            }, function () {
                $('.autocomplete_vendeur').css( "color", "#ddd" );

            });


        $('.acheteur_nif').hide();
        $('.acheteur_nrcselect').on('change', function() {
            if(this.value == 'NIF'){
                $('.acheteur_nrc').hide();
                $('.acheteur_nif').show();

            }
            if(this.value == 'NRC'){
                $('.acheteur_nrc').show();
                $('.acheteur_nif').hide();

            }
        });
        $('.departement_nif').hide();
        $('.departement_nrcselect').on('change', function() {
            if(this.value == 'NIF'){
                $('.departement_nrc').hide();
                $('.departement_nif').show();

            }
            if(this.value == 'NRC'){
                $('.departement_nrc').show();
                $('.departement_nif').hide();

            }
        });
        $('#indicator1').hide();
        $('#depenses_acheteur_type_0').change(function(){

            $('.particulier').hide();
            $('.selectid').show();
            $('.nif').show();

        });
        $('#depenses_acheteur_type_1').change(function(){

            $('.particulier').show();
            $('.selectid').hide();
            $('.nif').hide();


        });

        $('.acheteur_nom').on('keyup', function() { // everytime keyup event


            var input = $(this).val(); // We take the input value
            if ( input.length >= 2 ) { // Minimum characters = 2 (you can change)
                $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                var data = {input: input}; // We pass input argument in Ajax
                $.ajax({
                    type: "POST",
                    url: ROOT_URL2 , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                    data: data, // Send dataFields var
                    dataType: 'json', // json method
                    timeout: 3000,
                    success: function(response){ // If success

                        $('#acheteur').html(response.acheteur); // Return data (UL list) and insert it in the <div id="match"></div>
                        $('#matchList li').on('click', function() { // When click on an element in the list
                            $('.acheteur_nom').val($(this).attr('id')); // Update the field with the new element
                            $('#acheteur').text(''); // Clear the <div id="match"></div>
                            $.ajax({
                                type:'GET',
                                url: Routing.generate('admin_depenses_getacheteur',{acheteur:$(this).attr('value')}),
                                success: function (data) {
                                    $('.acheteur_id').val(data.id);
                                    $('.acheteur_nom').val(data.nom);
                                    $('.acheteur_nifselect').val(data.nifselect);
                                    $('.acheteur_nif').val(data.nif);
                                    $('.acheteur_nrc').val(data.nrc);
                                    $('.acheteur_adresse').val(data.adresse);
                                    $('.acheteur_codepostal').val(data.codepostal);
                                    $('.acheteur_ville').val(data.ville);
                                    $('.acheteur_email').val(data.email);
                                    $('.acheteur_site').val(data.siteweb);
                                    $('.acheteur_fax').val(data.fax);
                                    $('.acheteur_tel').val(data.telephone);
                                }
                            });
                        });
                        $('#indicator1').hide();
                    },
                    error: function() { // if error

                    }
                });
            } else {
                $('#match').text(''); // If less than 2 characters, clear the <div id="match"></div>
            }

        });

        $( 'a.autocomplete_vendeur' ).click(function() {


            var input = $(this).val(); // We take the input value

            $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
            var data = {input: input}; // We pass input argument in Ajax
            $.ajax({
                type: "POST",
                url: ROOT_URL2 , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                data: data, // Send dataFields var
                dataType: 'json', // json method
                timeout: 3000,
                success: function(response){ // If success
                    $('#acheteur').html(response.acheteur); // Return data (UL list) and insert it in the <div id="match"></div>
                    $('#matchList li').on('click', function() { // When click on an element in the list
                        $('.acheteur_nom').val($(this).attr('id')); // Update the field with the new element
                        $('#acheteur').text(''); // Clear the <div id="match"></div>
                        $.ajax({
                            type:'GET',
                            url: Routing.generate('admin_depenses_getacheteur',{acheteur:$(this).attr('value')}),
                            success: function (data) {
                                $('#acheteur').show();
                                $('.acheteur_id').val(data.id);
                                $('.acheteur_nom').val(data.nom);
                                $('.acheteur_nifselect').val(data.nifselect);
                                $('.acheteur_nif').val(data.nif);
                                $('.acheteur_nrc').val(data.nrc);
                                $('.acheteur_adresse').val(data.adresse);
                                $('.acheteur_codepostal').val(data.codepostal);
                                $('.acheteur_ville').val(data.ville);
                                $('.acheteur_email').val(data.email);
                                $('.acheteur_siteweb').val(data.siteweb);
                                $('.acheteur_fax').val(data.fax);
                                $('.acheteur_telephone').val(data.telephone);


                            }
                        });
                    });
                    $('#indicator1').hide();

                },
                error: function() { // if error

                }
            });

        });

    </script>


    <script>



        var $collectionHolder;
        // setup an "add a tag" link
        var $addTagLink = $('<a href="#" class="add_tag_link"><button type="button" class="btn btn-secondary"><i class="fa fa-plus" aria-hidden="true"></i> Produit</button></a>');
        var $newLinkLi = $('<ul style="position: absolute;margin-top: -15px;"></ul>').append($addTagLink);



        jQuery(document).ready(function() {

            $( ".forms" ).each(function( index ) {

                $("#bls_ventes_"+index+"_name").hide();
                $("#bls_ventes_"+index+"_reference").hide();
                $("#bls_ventes_"+index+"_qte").hide();
                $("#bls_ventes_"+index+"_unite").hide();
                $("#bls_ventes_"+index+"_puHT").hide();
                $("#bls_ventes_"+index+"_tva").hide();
                $("#bls_ventes_"+index+"_totalHT").show();
                $("#bls_ventes_"+index+"_totalTTC").show();
                $("#bls_ventes_"+index+"_description").hide();

                $("#bls_ventes_"+index+"_name").fadeIn('speed');
                $("#bls_ventes_"+index+"_reference").fadeIn('speed');
                $("#bls_ventes_"+index+"_qte").fadeIn('speed');
                $("#bls_ventes_"+index+"_unite").fadeIn('speed');
                $("#bls_ventes_"+index+"_puHT").fadeIn('speed');
                $("#bls_ventes_"+index+"_tva").fadeIn('speed');
                $("#bls_ventes_"+index+"_totalHT").fadeIn('speed');
                $("#bls_ventes_"+index+"_totalTTC").fadeIn('speed');
                $("#bls_ventes_"+index+"_description").fadeIn('speed');


                $( '#bls_ventes_'+index+'_user').val({{ app.user.id }}).prop("selected", true).hide();


                $('.productbls_ventes_'+index).append('<a style="position: absolute;z-index: 999;margin-top:-42px;margin-left: 93%;color: #ddd; text-decoration: none; cursor: pointer;" id="autocomplete_arrow'+index+'">'+'▼'+'</a>');
                $('.productbls_ventes_'+index).append('<div id="match'+index+'" style="position: absolute;z-index: 999;margin-top: 10px;margin-left: -4px; width: 100%;"></div>');
                $('#bls_ventes_'+index+'_name,'+'#autocomplete_arrow'+index).hover(

                    function () {
                        $('a#autocomplete_arrow'+index).css( "color", "#000" );
                    }, function () {
                        $('a#autocomplete_arrow'+index).css( "color", "#ddd" );

                    });
                $('input.number').number( true, 2, '.', ' ' );

                var reduct;
                $( '.discount1' ).click(function() {
                    $('.discount1').hide();
                    $('.discount2').fadeIn('speed');
                    $("#changehead").attr('class', 'col-md-4');
                    $('#change'+index).attr('class', 'col-md-4');
                    $('#changebls_ventes_'+index).attr('class', 'col-md-4');
                    $('.reduction').fadeIn('speed');
                    reduct = "oui";


                });
                $( '.discount2' ).click(function() {
                    $('.discount1').fadeIn('speed');
                    $('.discount2').hide();
                    $("#changehead").attr('class', 'col-md-5');
                    $('#change'+index).attr('class', 'col-md-5');
                    $('#changebls_ventes_'+index).attr('class', 'col-md-5');
                    $('.reduction').hide();

                    reduct = "non";

                });

                $( '.add_tag_link').click(function() {
                    if(reduct == 'oui'){
                        $("#changehead").attr('class', 'col-md-4');
                        $(".name").attr('class', 'col-md-4');
                        $('.reduction').fadeIn('speed');


                    }
                    if(reduct == 'non'){
                        $("#changehead").attr('class', 'col-md-5');
                        $(".name").attr('class', 'col-md-5');
                        $('.reduction').fadeOut('speed');

                    }

                });




                $('#bls_ventes_'+index+'_name').on('keyup', function() { // everytime keyup event

                    if($('#bls_ventes_'+index+'_reduction').val()){
                        reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                    }else {
                        reductionVal = 0;
                    }
                    var input = index; // We take the input value

                    $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                    var data = {input: input}; // We pass input argument in Ajax
                    if($('#bls_ventes_'+index+'_qte').val()){
                        qteVal = $('#bls_ventes_'+index+'_qte').val();
                    }else {
                        qteVal = 1;
                    }

                    var input = $(this).val(); // We take the input value
                    if ( input.length >= 2 ) { // Minimum characters = 2 (you can change)
                        $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                        var data = {input: input}; // We pass input argument in Ajax
                        $.ajax({
                            type: "POST",
                            url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                            data: data, // Send dataFields var
                            dataType: 'json', // json method
                            timeout: 3000,
                            success: function(response){ // If success
                                $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                                $('#matchList li').on('click', function() { // When click on an element in the list
                                    $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                                    $('#bls_ventes_'+index+'_name').text(''); // Clear the <div id="match"></div>

                                    $.ajax({
                                        type: "POST",
                                        url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                                        data: data, // Send dataFields var
                                        dataType: 'json', // json method
                                        timeout: 3000,
                                        success: function(response){ // If success
                                            $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                                            $('#matchList li').on('click', function() { // When click on an element in the list
                                                $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                                                $('#match'+index).text(''); // Clear the <div id="match"></div>
                                                if($('#bls_ventes_'+index+'_reduction').val()){
                                                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                                                }else {
                                                    reductionVal = 0;
                                                }

                                                $.ajax({
                                                    type:'GET',
                                                    url: Routing.generate('admin_depenses_prod',{prod:$(this).attr('value'), qte:$('#bls_ventes_'+index+'_qte').val(), tva:$('#bls_ventes_'+index+'_tva option:selected').text(), tva2:$('#bls_ventes_'+index+'_tva2 option:selected').text(),reduction:reductionVal}),
                                                    success: function (data) {

                                                        var totalHT = data.puAchat * $('#bls_ventes_'+index+'_qte').val();

                                                        $('#bls_ventes_'+index+'_produits').each(function(){

                                                            $(this).val(data.pid).prop("selected", true);

                                                        });

                                                        $('#bls_ventes_'+index+'_reference').each(function(){

                                                            $(this).val(data.reference);

                                                        });
                                                        $('#bls_ventes_'+index+'_unite').each(function(){

                                                            $(this).val(data.unite);


                                                        });
                                                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                                                            $(this).val(data.puAchat);

                                                        });
                                                        $('#bls_ventes_'+index+'_puHT').each(function(){

                                                            $(this).val(data.puHT);

                                                        });
                                                        $('#bls_ventes_'+index+'_puTTC').each(function(){

                                                            $(this).val(data.puTTC);

                                                        });
                                                        $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                                            $(this).val(data.puTTCa);

                                                        });

                                                        $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                                            $(this).val(data.totalHTa);


                                                        });
                                                        $('#bls_ventes_'+index+'_totalHT').each(function(){

                                                            $(this).val(data.totalHT);


                                                        });
                                                        $('#bls_ventes_'+index+'_tva2').each(function(){

                                                            $(this).val(data.TVAprod).prop("selected", true);



                                                        });
                                                        $('#bls_ventes_'+index+'_tva').each(function(){


                                                            $(this).val(data.TVA).prop("selected", true);



                                                        });
                                                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                                            $(this).val(totalHT * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + totalHT);

                                                        });
                                                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                                            $(this).val(data.TTC * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + data.TTC );

                                                        });
                                                        $('#bls_ventes_'+index+'_description').each(function(){

                                                            $(this).val(data.description);

                                                        });







                                                        var sum = 0;
                                                        $(".totalHTa").each(function() {
                                                            sum += parseFloat(+this.value.replace(/ /g, ''));
                                                        });


                                                        $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));




                                                        var sumTTC = 0;
                                                        $(".totalTTCa").each(function() {
                                                            sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                                                        });
                                                        $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                                                        $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                                                        valReduction = $('#bls_ventes_'+index+'_reduction').val() * data.totalHT /100 ;

                                                        $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (data.TTC - data.totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                                                        puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * data.totalHT /100 ;

                                                        $('#bls_ventes_'+index+'_puHTreduit').val(data.totalHT - valReduction  );



                                                        $('#bls_ventes_'+index+'_puTTCreduit').val((data.totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (data.totalHT - valReduction));


                                                        var sumReduction = 0;

                                                        $(".totalReduct").each(function() {
                                                            sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                                                        });
                                                        $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                                                        var sumtotalReduction = 0;

                                                        $('#bls_ventes_'+index+'_totalreduct').each(function() {
                                                            sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                                                        });
                                                        var sumtotalht = 0;
                                                        $(".totalhtr").each(function() {
                                                            sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                                                        });
                                                        var sumtotalttc = 0;
                                                        $(".totalttcr").each(function() {
                                                            sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                                                        });
                                                        $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                                                        $('#devis_totalHT').val(sumtotalht);
                                                        $('#devis_totalTTC').val(sumtotalttc);
                                                        $('#devis_totalReduction').val(sumReduction);
                                                        $('#indicator1').hide();
                                                        $('#devis_etat').change(function(){

                                                            if($('#devis_etat').val() == 'Payé'){
                                                                $('#devis_montantpaye').val(sumTTC)
                                                            }else {
                                                                $('#devis_montantpaye').val(null)
                                                            }

                                                        });




                                                    }
                                                });

                                            });
                                            $('#indicator1').hide();

                                        },
                                        error: function() { // if error

                                        }
                                    });



                                });
                                $('#indicator1').hide();
                            },
                            error: function() { // if error

                            }
                        });
                    } else {
                        $('#match'+index).text(''); // If less than 2 characters, clear the <div id="match"></div>
                    }

                });
                $('#bls_ventes_'+index+'_qte').keyup(function(){
                    $('#indicator1').show();
                    if($('#bls_ventes_'+index+'_puHT').val()){
                        puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                    }else {
                        puHTVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_prixHT').val()){
                        prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                    }else {
                        prixHTVal = 1;
                    }
                    $.ajax({
                        type:'GET',
                        url: Routing.generate('admin_bes_qte',{qte:$(this).val(), pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                        success: function (data) {
                            if(prixHTVal == 1){

                            }else {
                                $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                    $(this).val(data.totalHTa.toFixed(2));

                                });

                                $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                    $(this).val(data.TTC2.toFixed(2));

                                });
                            }
                            if(puHTVal == 1){

                            }else {
                                $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                    $(this).val(data.TTC.toFixed(2));

                                });
                                $('#bls_ventes_'+index+'_totalHT').each(function(){

                                    $(this).val(data.totalHT.toFixed(2));

                                });

                            }

                            var total = 0
                            var qte =0
                            $('.QTE').each(function(i){
                                if($('#bls_ventes_'+index+'_produits').val() == $('.aproprod'+i).val()) {

                                    $(this).attr('class', 'form-control QTE QTE'+i);
                                }
                                $('.aprofactqte').attr('class', 'totalqt aprofactqte aprofactqte'+i);
                                $('.aproqte').attr('class', 'aproqte aprofactqte'+i);
                                $('.produits').attr('class', 'produits  hidden produits'+i);
                                $('.aproprod').attr('class', 'aproprod aproprod'+i);
                                qteapro = $('#bls_aprofact_'+i+'_qte').val();

                                $('.QTE'+i).each(function(){
                                    qte += parseInt(+$(this).val());
                                    qtedefault = $('.aprofactqte'+$('#bls_ventes_'+index+'_produits').val()).val(qte);
                                    total = parseInt(qte) ;
                                    if($('#bls_ventes_'+index+'_produits').val() == $('.aproprod'+i).val()){



                                        $('.aprofactqte'+i).val(qte);





                                    }
                                });






                            });


                            var sum = 0;
                            $(".totalHTa").each(function() {
                                sum += parseInt(+this.value);
                            });
                            $('#sum_net').text(sum.toFixed(2));

                            var sumTVA = 0;
                            $(".TVA2").each(function() {
                                sumTVA += parseInt(+data.totalTVA2);
                            });
                            $('#sum_tva').text(sumTVA.toFixed(2));

                            var sumTTC = 0;
                            $(".totalTTCa").each(function() {
                                sumTTC += parseInt(+this.value);
                            });
                            $('#sum_ttc').text(sumTTC.toFixed(2));

                            var sumReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumReduction += parseFloat(+data.reduction);
                            });
                            $('#sum_discount').text(sumReduction.toFixed(2));

                            var sumtotalReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumtotalReduction += parseFloat(+data.totalReduction);
                            });
                            $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                            $('#indicator1').hide();
                        }

                    });



                });



                $('#bls_ventes_'+index+'_prixHT').keyup(function(){
                    $('#indicator1').show();
                    if($('#bls_ventes_'+index+'_qte').val()){
                        qteVal = 1;
                    }else {
                        qteVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_puHT').val()){
                        puHTVal = 1;
                    }else {
                        puHTVal = 1;
                    }
                    $.ajax({
                        type:'GET',
                        url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:$('#bls_ventes_'+index+'_prixHT').val(), tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                        success: function (data) {

                            $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                $(this).val(data.TTC2.toFixed(2));

                            });

                            if($('#bls_ventes_'+index+'_qte').val()){

                                $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                    $(this).val(data.totalHTa * $('#bls_ventes_'+index+'_qte').val());

                                });

                                $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                    $(this).val(data.TTC2.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                                });

                            }



                            var sum = 0;
                            $(".totalHTa").each(function() {
                                sum += parseInt(+this.value);
                            });
                            $('#sum_net').text(sum.toFixed(2));

                            var sumTVA = 0;
                            $(".TVA2").each(function() {
                                sumTVA += parseInt(+data.totalTVA2);
                            });
                            $('#sum_tva').text(sumTVA.toFixed(2));

                            var sumTTC = 0;
                            $(".totalTTCa").each(function() {
                                sumTTC += parseInt(+this.value);
                            });
                            $('#sum_ttc').text(sumTTC.toFixed(2));

                            var sumReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumReduction += parseFloat(+data.reduction);
                            });
                            $('#sum_discount').text(sumReduction.toFixed(2));

                            var sumtotalReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumtotalReduction += parseFloat(+data.totalReduction);
                            });
                            $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                            $('#indicator1').hide();
                        }

                    });



                });
                $('#bls_ventes_'+index+'_puHT').keyup(function(){
                    $('#indicator1').show();
                    if($('#bls_ventes_'+index+'_qte').val()){
                        qteVal = 1;
                    }else {
                        qteVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_prixHT').val()){
                        prixHTVal = 1;
                    }else {
                        prixHTVal = 1;
                    }
                    $.ajax({
                        type:'GET',
                        url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:$('#bls_ventes_'+index+'_puHT').val(),pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                        success: function (data) {

                            $('#bls_ventes_'+index+'_puTTC').each(function(){

                                $(this).val(data.TTC.toFixed(2));

                            });

                            if($('#bls_ventes_'+index+'_qte').val()){

                                $('#bls_ventes_'+index+'_totalHT').each(function(){

                                    $(this).val(data.totalHT.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                                });

                                $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                    $(this).val(data.TTC.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                                });

                            }
                            var sum = 0;
                            $(".totalHTa").each(function() {
                                sum += parseInt(+this.value);
                            });
                            $('#sum_net').text(sum.toFixed(2));

                            var sumTVA = 0;
                            $(".TVA2").each(function() {
                                sumTVA += parseInt(+data.totalTVA2);
                            });
                            $('#sum_tva').text(sumTVA.toFixed(2));

                            var sumTTC = 0;
                            $(".totalTTCa").each(function() {
                                sumTTC += parseInt(+this.value);
                            });
                            $('#sum_ttc').text(sumTTC.toFixed(2));

                            var sumReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumReduction += parseFloat(+data.reduction);
                            });
                            $('#sum_discount').text(sumReduction.toFixed(2));

                            var sumtotalReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumtotalReduction += parseFloat(+data.totalReduction);
                            });
                            $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                            $('#indicator1').hide();
                        }

                    });



                });

                $('#bls_ventes_'+index+'_prixTTC').keyup(function(){



                    var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 +1;


                    $('#bls_ventes_'+index+'_prixHT').each(function(){
                        var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 +1;


                        var prixht= $('#bls_ventes_'+index+'_prixTTC').val() / TVA;

                        $(this).val(prixht.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_totalHTa').each(function(){

                        var totalHT = $('#bls_ventes_'+index+'_prixHT').val() * $('#bls_ventes_'+index+'_qte').val();
                        $(this).val(totalHT.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                        var totalTTC = $('#bls_ventes_'+index+'_prixTTC').val() * $('#bls_ventes_'+index+'_qte').val();
                        $(this).val(totalTTC.toFixed(2));

                    });

                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();
                });
                $('#bls_ventes_'+index+'_puTTC').keyup(function(){



                    var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 +1;


                    $('#bls_ventes_'+index+'_puHT').each(function(){
                        var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 +1;


                        var prixht= $('#bls_ventes_'+index+'_puTTC').val() / TVA;

                        $(this).val(prixht.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_totalHT').each(function(){

                        var totalHT = $('#bls_ventes_'+index+'_puHT').val() * $('#bls_ventes_'+index+'_qte').val();
                        $(this).val(totalHT.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                        var totalTTC = $('#bls_ventes_'+index+'_puTTC').val() * $('#bls_ventes_'+index+'_qte').val();
                        $(this).val(totalTTC.toFixed(2));

                    });

                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();
                });

                $('#bls_ventes_'+index+'_tva2').change(function(){
                    $('#indicator1').show();
                    if($('#bls_ventes_'+index+'_qte').val()){
                        qteVal = 1;
                    }else {
                        qteVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_puHT').val()){
                        puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                    }else {
                        puHTVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_prixHT').val()){
                        prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                    }else {
                        prixHTVal = 1;
                    }
                    $.ajax({
                        type:'GET',
                        url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                        success: function (data) {
                            if(prixHTVal == 1){

                            }else {
                                $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                    $(this).val(data.TTC2);

                                });
                                if($('#bls_ventes_'+index+'_qte').val()) {
                                    $('#bls_ventes_' + index + '_totalTTCa').each(function () {

                                        $(this).val(data.TTC2 * $('#bls_ventes_' + index + '_qte').val());

                                    });
                                }

                            }


                            var sum = 0;
                            $(".totalHTa").each(function() {
                                sum += parseInt(+this.value);
                            });
                            $('#sum_net').text(sum.toFixed(2));

                            var sumTVA = 0;
                            $(".TVA2").each(function() {
                                sumTVA += parseInt(+data.totalTVA2);
                            });
                            $('#sum_tva').text(sumTVA.toFixed(2));

                            var sumTTC = 0;
                            $(".totalTTCa").each(function() {
                                sumTTC += parseInt(+this.value);
                            });
                            $('#sum_ttc').text(sumTTC.toFixed(2));

                            var sumReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumReduction += parseFloat(+data.reduction);
                            });
                            $('#sum_discount').text(sumReduction.toFixed(2));

                            var sumtotalReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumtotalReduction += parseFloat(+data.totalReduction);
                            });
                            $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                            $('#indicator1').hide();
                        }

                    });



                });
                $('#bls_ventes_'+index+'_tva').change(function(){
                    $('#indicator1').show();
                    if($('#bls_ventes_'+index+'_qte').val()){
                        qteVal = 1;
                    }else {
                        qteVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_puHT').val()){
                        puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                    }else {
                        puHTVal = 1;
                    }
                    if($('#bls_ventes_'+index+'_prixHT').val()){
                        prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                    }else {
                        prixHTVal = 1;
                    }
                    $.ajax({
                        type:'GET',
                        url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                        success: function (data) {
                            if(prixHTVal == 1){

                            }else {
                                $('#bls_ventes_'+index+'_puTTC').each(function(){

                                    $(this).val(data.TTC);

                                });
                                if($('#bls_ventes_'+index+'_qte').val()) {
                                    $('#bls_ventes_' + index + '_totalTTC').each(function () {

                                        $(this).val(data.TTC2 * $('#bls_ventes_' + index + '_qte').val());

                                    });
                                }

                            }
                            if(puHTVal == 1){

                            }else {

                                $('#bls_ventes_'+index+'_puTTC').each(function(){

                                    $(this).val(data.TTC);

                                });

                                if($('#bls_ventes_'+index+'_qte').val()) {
                                    $('#bls_ventes_' + index + '_totalTTC').each(function () {

                                        $(this).val(data.TTC * $('#bls_ventes_' + index + '_qte').val());

                                    });
                                }

                            }

                            var sum = 0;
                            $(".totalHTa").each(function() {
                                sum += parseInt(+this.value);
                            });
                            $('#sum_net').text(sum.toFixed(2));

                            var sumTVA = 0;
                            $(".TVA2").each(function() {
                                sumTVA += parseInt(+data.totalTVA2);
                            });
                            $('#sum_tva').text(sumTVA.toFixed(2));

                            var sumTTC = 0;
                            $(".totalTTCa").each(function() {
                                sumTTC += parseInt(+this.value);
                            });
                            $('#sum_ttc').text(sumTTC.toFixed(2));

                            var sumReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumReduction += parseFloat(+data.reduction);
                            });
                            $('#sum_discount').text(sumReduction.toFixed(2));

                            var sumtotalReduction = 0;
                            $(".REDUCTION").each(function() {
                                sumtotalReduction += parseFloat(+data.totalReduction);
                            });
                            $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                            $('#indicator1').hide();
                        }

                    });



                });

                $('#bls_ventes_'+index+'_totalHTa').keyup(function(){
                    $('#indicator1').hide();
                    if($('#bls_ventes_'+index+'_reduction').val()){
                        reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                    }else {
                        reductionVal = 0;
                    }

                    var totalHT = $('#bls_ventes_'+index+'_totalHTa').val() * $('#bls_ventes_'+index+'_qte').val();

                    var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 ;

                    var TTC = totalHT * TVA + totalHT;

                    var totalTVA = totalHT * TVA;
                    totalttc = $('#bls_ventes_'+index+'_totalTTCa').val();
                    totalht = $('#bls_ventes_'+index+'_totalHTa').val();
                    tvaval= ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100)+1;



                    $('#bls_ventes_'+index+'_totalTTCa').val( (TTC/$('#bls_ventes_'+index+'_qte').val()).toFixed(2) );
                    var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_prixTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                    if($('#bls_ventes_'+index+'_qte').val() >= 1){
                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                            $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                        });
                        $('#bls_ventes_'+index+'_prixHT').each(function(){
                            totalpu = $('#bls_ventes_'+index+'_totalHTa').val() / $('#bls_ventes_'+index+'_qte').val();

                            $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHTa').each(function(){
                            totalht =  $(this).val();

                            $(this).val();

                        });
                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                            $(this).val();

                        });

                        $('#bls_ventes_'+index+'_tva2').each(function(){

                            $(this).attr('value',totalTVA2);


                        });
                        $('#bls_ventes_'+index+'_tva2').change(function(){

                            $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));


                        });
                    }else {


                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                            $(this).val(totalHTa.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHTa').each(function(){

                            $(this).val(TTCa.toFixed(2));

                        });

                        $('#bls_ventes_'+index+'_tva2').each(function(){

                            $(this).attr('value',totalTVA);


                        });

                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });

                        var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                        $('#bls_ventes_'+index+'_prixTTC').each(function(){

                            $(this).val( ttca.toFixed(2) );

                        });
                    }


                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();

                });
                $('#bls_ventes_'+index+'_totalTTCa').keyup(function(){
                    $('#indicator1').hide();
                    if($('#bls_ventes_'+index+'_reduction').val()){
                        reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                    }else {
                        reductionVal = 0;
                    }
                    var totalHT = $('#bls_ventes_'+index+'_totalHTa').val() * $('#bls_ventes_'+index+'_qte').val();

                    var TVA = ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100) ;

                    var TTC = totalHT * TVA + totalHT;

                    var totalTVA = totalHT * TVA;

                    totalttc = $('#bls_ventes_'+index+'_totalTTCa').val();
                    totalht = $('#bls_ventes_'+index+'_totalHTa').val();
                    tvaval= ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100)+1;


                    $('#bls_ventes_'+index+'_totalHTa').val( (totalttc  / tvaval).toFixed(2) );
                    $('#bls_ventes_'+index+'_prixHT').val($('#bls_ventes_'+index+'_totalHTa').val());


                    if($('#bls_ventes_'+index+'_qte').val() >= 1){
                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                            $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                        });
                        $('#bls_ventes_'+index+'_prixHT').each(function(){
                            totalpu = $('#bls_ventes_'+index+'_totalHTa').val() / $('#bls_ventes_'+index+'_qte').val();

                            $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHTa').each(function(){
                            totalht =  $(this).val();

                            $(this).val();

                        });
                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                            $(this).val();

                        })



                        $('#bls_ventes_'+index+'_tva2').each(function(){

                            $(this).attr('value',totalTVA);


                        });
                        $('#bls_ventes_'+index+'_tva2').change(function(){

                            $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));


                        });


                        var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                        $('#bls_ventes_'+index+'_prixTTC').each(function(){

                            $(this).val( ttca.toFixed(2) );

                        });
                    }else {


                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                            $(this).val(totalHT.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHTa').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });

                        $('#bls_ventes_'+index+'_tva2').each(function(){

                            $(this).attr('value',totalTVA);


                        });

                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });


                    }



                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * $('#bls_ventes_'+index+'_totalTTCa').val() /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva2 option:selected').text()/100) + (totalHTa - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();


                });

                $('#bls_ventes_'+index+'_totalHT').keyup(function(){
                    $('#indicator1').hide();
                    if($('#bls_ventes_'+index+'_reduction').val()){
                        reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                    }else {
                        reductionVal = 0;
                    }

                    var totalHT = $('#bls_ventes_'+index+'_totalHT').val() * $('#bls_ventes_'+index+'_qte').val();

                    var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 ;

                    var TTC = totalHT * TVA + totalHT;

                    var totalTVA = totalHT * TVA;
                    totalttc = $('#bls_ventes_'+index+'_totalTTC').val();
                    totalht = $('#bls_ventes_'+index+'_totalHT').val();
                    tvaval= ($('#bls_ventes_'+index+'_tva option:selected').text() / 100)+1;



                    $('#bls_ventes_'+index+'_totalTTC').val( (TTC/$('#bls_ventes_'+index+'_qte').val()).toFixed(2) );
                    var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_puTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                    if($('#bls_ventes_'+index+'_qte').val() >= 1){
                        $('#bls_ventes_'+index+'_puHT').each(function(){

                            $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                        });
                        $('#bls_ventes_'+index+'_puHT').each(function(){
                            totalpu = $('#bls_ventes_'+index+'_totalHT').val() / $('#bls_ventes_'+index+'_qte').val();

                            $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHT').each(function(){
                            totalht =  $(this).val();

                            $(this).val();

                        });
                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                            $(this).val();

                        });

                        $('#bls_ventes_'+index+'_tva').each(function(){

                            $(this).attr('value',totalTVA2);


                        });
                        $('#bls_ventes_'+index+'_tva').change(function(){

                            $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));


                        });
                    }else {


                        $('#bls_ventes_'+index+'_puHT').each(function(){

                            $(this).val(totalHTa.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHT').each(function(){

                            $(this).val(TTCa.toFixed(2));

                        });

                        $('#bls_ventes_'+index+'_tva').each(function(){

                            $(this).attr('value',totalTVA);


                        });

                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });

                        var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                        $('#bls_ventes_'+index+'_puTTC').each(function(){

                            $(this).val( ttca.toFixed(2) );

                        });
                    }


                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();

                });
                $('#bls_ventes_'+index+'_totalTTC').keyup(function(){
                    $('#indicator1').hide();
                    if($('#bls_ventes_'+index+'_reduction').val()){
                        reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                    }else {
                        reductionVal = 0;
                    }
                    var totalHT = $('#bls_ventes_'+index+'_totalHT').val() * $('#bls_ventes_'+index+'_qte').val();

                    var TVA = ($('#bls_ventes_'+index+'_tva option:selected').text() / 100) ;

                    var TTC = totalHT * TVA + totalHT;

                    var totalTVA = totalHT * TVA;

                    totalttc = $('#bls_ventes_'+index+'_totalTTC').val();
                    totalht = $('#bls_ventes_'+index+'_totalHT').val();
                    tvaval= ($('#bls_ventes_'+index+'_tva option:selected').text() / 100)+1;


                    $('#bls_ventes_'+index+'_totalHT').val( (totalttc  / tvaval).toFixed(2) );
                    $('#bls_ventes_'+index+'_puHT').val($('#bls_ventes_'+index+'_totalHT').val());


                    if($('#bls_ventes_'+index+'_qte').val() >= 1){
                        $('#bls_ventes_'+index+'_puHT').each(function(){

                            $(this).val($('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val() );

                        });
                        $('#bls_ventes_'+index+'_puHT').each(function(){
                            totalpu = $('#bls_ventes_'+index+'_totalHT').val() / $('#bls_ventes_'+index+'_qte').val();

                            $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHT').each(function(){
                            totalht =  $(this).val();

                            $(this).val();

                        });
                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                            $(this).val();

                        })



                        $('#bls_ventes_'+index+'_tva').each(function(){

                            $(this).attr('value',totalTVA);


                        });
                        $('#bls_ventes_'+index+'_tva').change(function(){

                            $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));


                        });


                        var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                        $('#bls_ventes_'+index+'_puTTC').each(function(){

                            $(this).val( ttca.toFixed(2) );

                        });
                    }else {


                        $('#bls_ventes_'+index+'_puHT').each(function(){

                            $(this).val(totalHT.toFixed(2));

                        });
                        $('#bls_ventes_'+index+'_totalHT').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });

                        $('#bls_ventes_'+index+'_tva').each(function(){

                            $(this).attr('value',totalTVA);


                        });

                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                            $(this).val(TTC.toFixed(2));

                        });


                    }



                    var sum = 0;
                    $(".totalHTa").each(function() {
                        sum += parseFloat(+this.value.replace(/ /g, ''));
                    });


                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                    var sumTTC = 0;
                    $(".totalTTCa").each(function() {
                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * $('#bls_ventes_'+index+'_totalTTCa').val() /100 ;

                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                    $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                    $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva2 option:selected').text()/100) + (totalHTa - valReduction));


                    var sumReduction = 0;

                    $(".totalReduct").each(function() {
                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                    var sumtotalReduction = 0;

                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                    });
                    var sumtotalht = 0;
                    $(".totalhtr").each(function() {
                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    var sumtotalttc = 0;
                    $(".totalttcr").each(function() {
                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                    });
                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                    $('#depenses_totalHT').val(sumtotalht);
                    $('#depenses_totalTTC').val(sumtotalttc);
                    $('#depenses_totalReduction').val(sumReduction);
                    $('#indicator1').hide();


                });
                $( 'a#autocomplete_arrow'+index ).click(function() {
                    $('#bls_ventes_'+index+'_reduction').val(0);
                    var input = $(this).val(); // We take the input value

                    $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                    var data = {input: input}; // We pass input argument in Ajax
                    $.ajax({
                        type: "POST",
                        url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                        data: data, // Send dataFields var
                        dataType: 'json', // json method
                        timeout: 3000,
                        success: function(response){ // If success
                            $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                            $('#matchList li').on('click', function() { // When click on an element in the list
                                $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                                $('#match'+index).text(''); // Clear the <div id="match"></div>
                                if($('#bls_ventes_'+index+'_reduction').val()){
                                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                                }else {
                                    reductionVal = 0;
                                }

                                $.ajax({
                                    type:'GET',
                                    url: Routing.generate('admin_depenses_prod',{prod:$(this).attr('value'), qte:$('#bls_ventes_'+index+'_qte').val(), tva2:$('#bls_ventes_'+index+'_tva2 option:selected').text(), tva:$('#bls_ventes_'+index+'_tva option:selected').text(),reduction:reductionVal}),
                                    success: function (data) {

                                        var totalHT = data.puAchat * $('#bls_ventes_'+index+'_qte').val();

                                        $('#bls_ventes_'+index+'_produits').each(function(){

                                            $(this).val(data.pid).prop("selected", true);

                                        });

                                        $('#bls_ventes_'+index+'_reference').each(function(){

                                            $(this).val(data.reference);

                                        });
                                        $('#bls_ventes_'+index+'_unite').each(function(){

                                            $(this).val(data.unite);


                                        });
                                        $('#bls_ventes_'+index+'_prixHT').each(function(){

                                            $(this).val(data.puAchat);

                                        });
                                        $('#bls_ventes_'+index+'_puHT').each(function(){

                                            $(this).val(data.puHT);

                                        });
                                        $('#bls_ventes_'+index+'_puTTC').each(function(){

                                            $(this).val(data.puTTC);

                                        });
                                        $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                            $(this).val(data.puTTCa);

                                        });

                                        $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                            $(this).val(data.totalHTa);


                                        });
                                        $('#bls_ventes_'+index+'_totalHT').each(function(){

                                            $(this).val(data.totalHT);


                                        });

                                        $('#bls_ventes_'+index+'_tva2').each(function(){

                                            $(this).val(data.TVAprod).prop("selected", true);

                                        });
                                        $('#bls_ventes_'+index+'_tva').each(function(){


                                            $(this).val(data.TVA).prop("selected", true);


                                        });

                                        $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                            $(this).val(totalHT * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + totalHT);

                                        });
                                        $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                            $(this).val(data.TTC * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + data.TTC );

                                        });
                                        $('#bls_ventes_'+index+'_description').each(function(){

                                            $(this).val(data.description);

                                        });







                                        var sum = 0;
                                        $(".totalHTa").each(function() {
                                            sum += parseFloat(+this.value.replace(/ /g, ''));
                                        });


                                        $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));




                                        var sumTTC = 0;
                                        $(".totalTTCa").each(function() {
                                            sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                                        });
                                        $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                                        $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                                        valReduction = $('#bls_ventes_'+index+'_reduction').val() * data.totalHT /100 ;

                                        $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (data.TTC - data.totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                                        puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * data.totalHT /100 ;

                                        $('#bls_ventes_'+index+'_puHTreduit').val(data.totalHT - valReduction  );



                                        $('#bls_ventes_'+index+'_puTTCreduit').val((data.totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (data.totalHT - valReduction));


                                        var sumReduction = 0;

                                        $(".totalReduct").each(function() {
                                            sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                                        });
                                        $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                                        var sumtotalReduction = 0;

                                        $('#bls_ventes_'+index+'_totalreduct').each(function() {
                                            sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                                        });
                                        var sumtotalht = 0;
                                        $(".totalhtr").each(function() {
                                            sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                                        });
                                        var sumtotalttc = 0;
                                        $(".totalttcr").each(function() {
                                            sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                                        });
                                        $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                                        $('#devis_totalHT').val(sumtotalht);
                                        $('#devis_totalTTC').val(sumtotalttc);
                                        $('#devis_totalReduction').val(sumReduction);
                                        $('#indicator1').hide();
                                        $('#devis_etat').change(function(){

                                            if($('#devis_etat').val() == 'Payé'){
                                                $('#devis_montantpaye').val(sumTTC)
                                            }else {
                                                $('#devis_montantpaye').val(null)
                                            }

                                        });




                                    }
                                });

                            });
                            $('#indicator1').hide();

                        },
                        error: function() { // if error

                        }
                    });

                });




                $('#depenses_etat').change(function(){

                    if($('#depenses_etat').val() == 'Payé'){
                        $('#depenses_montantpaye').val(accounting.formatMoney($('#bls_ventes_'+index+'_puTTCreduit').val(), "", 2, " ", ","))
                    }else {
                        $('#depenses_montantpaye').val(null)
                    }

                });
            });

            $('#more2').hide();
            $('#more3').hide();

            $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
            $.ajax({
                type:'GET',
                url:Routing.generate('admin_depenses_getuser',{user:{{ app.user.id }}}),
                success: function (data) {

                    $('.departement_id').val(data.id).prop("selected", true);
                    $('.departement_nom').val(data.nom);
                    $('.departement_nifselect').val(data.nifselect);
                    $('.departement_nif').val(data.nif);
                    $('.departement_nrc').val(data.nrc);
                    $('.departement_adresse').val(data.adresse);
                    $('.departement_codepostal').val(data.codepostal);
                    $('.departement_ville').val(data.ville);
                    $('.departement_email').val(data.email);
                    $('.departement_site').val(data.siteweb);
                    $('.departement_fax').val(data.fax);
                    $('.departement_tel').val(data.telephone);



                    if(data.nom){
                        $('.departement_view').append('<p>'+data.nom+'</p>');
                        if(data.nrc){
                            $('.departement_view').append('<p>'+'N° RC: '+ data.nrc +'</p>');
                        }
                        if(data.nif){
                            $('.departement_view').append('<p>'+'NIF: '+ data.nif +'</p>');
                        }

                        $('.departement_view').append('<p>'+data.adresse+','+ data.codepostal+'</p>' + '<p>'+data.ville+'</p>');

                        $('.departement_view').append('<span class="btn btn-glow btn-xs departement_button ">Modifier</span>');


                        $('.departement_button').on('click', function(e) {

                            $('.departement_view').hide();
                            $('.departement_form').show();


                        });
                    } else {

                        $('.departement_view').hide();
                        $('.departement_form').show();
                    }
                    $('#indicator1').hide();// Loader icon apprears in the <div id="match"></div>
                },
                error: function() { // if error

                    $('#indicator1').hide();
                }
            });


            $('.departement_id').change(function(){
                $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                $('.departement_nom').val('');
                $('.departement_nifselect').val('');
                $('.departement_nif').val('');
                $('.departement_nrc').val('');
                $('.departement_adresse').val('');
                $('.departement_codepostal').val('');
                $('.departement_ville').val('');
                $('.departement_email').val('');
                $('.departement_site').val('');
                $('.departement_fax').val();
                $('.departement_tel').val('');
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_depenses_getdep',{dep:$('#depenses_departements_id').val()}),

                    success: function (data) {
                        $('.departement_id').val(data.id).prop("selected", true);
                        $('.departement_nom').val(data.nom);
                        $('.departement_nifselect').val(data.nifselect);
                        $('.departement_nif').val(data.nif);
                        $('.departement_nrc').val(data.nrc);
                        $('.departement_adresse').val(data.adresse);
                        $('.departement_codepostal').val(data.codepostal);
                        $('.departement_ville').val(data.ville);
                        $('.departement_email').val(data.email);
                        $('.departement_site').val(data.siteweb);
                        $('.departement_fax').val(data.fax);
                        $('.departement_tel').val(data.telephone);

                        $('#indicator1').hide();// Loader icon apprears in the <div id="match"></div>
                    }
                });
                if($('depenses_departements_id option').val() == null){
                    $('#indicator1').hide();
                }

            });



            // Get the ul that holds the collection of tags
            $collectionHolder = $('div.tags');
            $collectionHolder2 = $('div.lignes');

            $collectionHolder.find('.forms').each(function() {
                addTagFormDeleteLink($(this));
            });
            $('.del').each(function(i) {

                $(this).attr('class', 'del del'+i);



            });
            $('.aprofact').each(function(i) {

                $(this).attr('class', 'aprofact aprofact'+i);


                $(".del"+i).on('click', function()  {


                    $('.aprofact'+i).remove();



                });


            });


            // add the "add a tag" anchor and li to the tags ul
            $collectionHolder.append($newLinkLi);



            // count the current form inputs we have (e.g. 2), use that as the new
            // index when inserting a new item (e.g. 2)
            $collectionHolder.data('index', $collectionHolder.find(':input').length);

            $addTagLink.on('click', function(e) {
                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                // add a new tag form (see next code block)
                addTagForm($collectionHolder, $newLinkLi);


            });



        });


        $('.reduction').hide();
        $('.discount2').hide();


        function addTagForm($collectionHolder, $newLinkLi) {
            // Get the data-prototype explained earlier
            var prototype = $collectionHolder.data('prototype');

            // get the new index
            var index = $collectionHolder.data('index');

            // Replace '__name__' in the prototype's HTML to
            // instead be a number based on how many items we have
            var newForm = prototype.replace(/__name__/g, index);

            // increase the index with one for the next item
            $collectionHolder.data('index', index + 1);



            // Display the form in the page in an li, before the "Add a tag" link li
            var $newFormLi = $("<div id='"+index+ "'></div>").append(newForm);


            $newLinkLi.before($newFormLi);
            $('#bls_ventes_'+index+'_qte').each(function(){

                $(this).val(1);


            });
            $("#bls_ventes_"+index+"_name").hide();
            $("#bls_ventes_"+index+"_reference").hide();
            $("#bls_ventes_"+index+"_qte").hide();
            $("#bls_ventes_"+index+"_unite").hide();
            $("#bls_ventes_"+index+"_puHT").hide();
            $("#bls_ventes_"+index+"_tva").hide();
            $("#bls_ventes_"+index+"_totalHT").hide();
            $("#bls_ventes_"+index+"_totalTTC").hide();
            $("#bls_ventes_"+index+"_description").hide();

            $("#bls_ventes_"+index+"_name").fadeIn('speed');
            $("#bls_ventes_"+index+"_reference").fadeIn('speed');
            $("#bls_ventes_"+index+"_qte").fadeIn('speed');
            $("#bls_ventes_"+index+"_unite").fadeIn('speed');
            $("#bls_ventes_"+index+"_puHT").fadeIn('speed');
            $("#bls_ventes_"+index+"_tva").fadeIn('speed');
            $("#bls_ventes_"+index+"_totalHT").fadeIn('speed');
            $("#bls_ventes_"+index+"_totalTTC").fadeIn('speed');
            $("#bls_ventes_"+index+"_description").fadeIn('speed');


            $( '#bls_ventes_'+index+'_user').val({{ app.user.id }}).prop("selected", true).hide();
            $('#bls_ventes_'+index+'_qte').val(1)
            addTagFormDeleteLink($newFormLi);
            $('.productbls_ventes_'+index).append('<a style="position: absolute;z-index: 999;margin-top:-42px;margin-left: 93%;color: #ddd; text-decoration: none; cursor: pointer;" id="autocomplete_arrow'+index+'">'+'▼'+'</a>');
            $('.productbls_ventes_'+index).append('<div id="match'+index+'" style="position: absolute;z-index: 999;margin-top: 10px;margin-left: -4px; width: 100%;"></div>');
            $('#bls_ventes_'+index+'_name,'+'#autocomplete_arrow'+index).hover(

                function () {
                    $('a#autocomplete_arrow'+index).css( "color", "#000" );
                }, function () {
                    $('a#autocomplete_arrow'+index).css( "color", "#ddd" );

                });
            $('input.number').number( true, 2, '.', ' ' );

            var reduct;
            $( '.discount1' ).click(function() {
                $('.discount1').hide();
                $('.discount2').fadeIn('speed');
                $("#changehead").attr('class', 'col-md-4');
                $('#change'+index).attr('class', 'col-md-4');
                $('#changebls_ventes_'+index).attr('class', 'col-md-4');
                $('.reduction').fadeIn('speed');
                reduct = "oui";


            });
            $( '.discount2' ).click(function() {
                $('.discount1').fadeIn('speed');
                $('.discount2').hide();
                $("#changehead").attr('class', 'col-md-5');
                $('#change'+index).attr('class', 'col-md-5');
                $('#changebls_ventes_'+index).attr('class', 'col-md-5');
                $('.reduction').hide();

                reduct = "non";

            });

            $( '.add_tag_link').click(function() {
                if(reduct == 'oui'){
                    $("#changehead").attr('class', 'col-md-4');
                    $(".name").attr('class', 'col-md-4');
                    $('.reduction').fadeIn('speed');


                }
                if(reduct == 'non'){
                    $("#changehead").attr('class', 'col-md-5');
                    $(".name").attr('class', 'col-md-5');
                    $('.reduction').fadeOut('speed');

                }

            });


            $('#bls_ventes_'+index+'_name').on('keyup', function() { // everytime keyup event

                if($('#bls_ventes_'+index+'_reduction').val()){
                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                }else {
                    reductionVal = 0;
                }
                var input = index; // We take the input value

                $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                var data = {input: input}; // We pass input argument in Ajax
                if($('#bls_ventes_'+index+'_qte').val()){
                    qteVal = $('#bls_ventes_'+index+'_qte').val();
                }else {
                    qteVal = 1;
                }

                var input = $(this).val(); // We take the input value
                if ( input.length >= 2 ) { // Minimum characters = 2 (you can change)
                    $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                    var data = {input: input}; // We pass input argument in Ajax
                    $.ajax({
                        type: "POST",
                        url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                        data: data, // Send dataFields var
                        dataType: 'json', // json method
                        timeout: 3000,
                        success: function(response){ // If success
                            $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                            $('#matchList li').on('click', function() { // When click on an element in the list
                                $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                                $('#bls_ventes_'+index+'_name').text(''); // Clear the <div id="match"></div>

                                $.ajax({
                                    type: "POST",
                                    url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                                    data: data, // Send dataFields var
                                    dataType: 'json', // json method
                                    timeout: 3000,
                                    success: function(response){ // If success
                                        $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                                        $('#matchList li').on('click', function() { // When click on an element in the list
                                            $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                                            $('#match'+index).text(''); // Clear the <div id="match"></div>
                                            if($('#bls_ventes_'+index+'_reduction').val()){
                                                reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                                            }else {
                                                reductionVal = 0;
                                            }

                                            $.ajax({
                                                type:'GET',
                                                url: Routing.generate('admin_depenses_prod',{prod:$(this).attr('value'), qte:$('#bls_ventes_'+index+'_qte').val(), tva:$('#bls_ventes_'+index+'_tva option:selected').text(), tva2:$('#bls_ventes_'+index+'_tva2 option:selected').text(),reduction:reductionVal}),
                                                success: function (data) {

                                                    var totalHT = data.puAchat * $('#bls_ventes_'+index+'_qte').val();

                                                    $('#bls_ventes_'+index+'_produits').each(function(){

                                                        $(this).val(data.pid).prop("selected", true);

                                                    });

                                                    $('#bls_ventes_'+index+'_reference').each(function(){

                                                        $(this).val(data.reference);

                                                    });
                                                    $('#bls_ventes_'+index+'_unite').each(function(){

                                                        $(this).val(data.unite);


                                                    });
                                                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                                                        $(this).val(data.puAchat);

                                                    });
                                                    $('#bls_ventes_'+index+'_puHT').each(function(){

                                                        $(this).val(data.puHT);

                                                    });
                                                    $('#bls_ventes_'+index+'_puTTC').each(function(){

                                                        $(this).val(data.puTTC);

                                                    });
                                                    $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                                        $(this).val(data.puTTCa);

                                                    });

                                                    $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                                        $(this).val(data.totalHTa);


                                                    });
                                                    $('#bls_ventes_'+index+'_totalHT').each(function(){

                                                        $(this).val(data.totalHT);


                                                    });
                                                    $('#bls_ventes_'+index+'_tva2').each(function(){

                                                        $(this).val(data.TVAprod).prop("selected", true);



                                                    });
                                                    $('#bls_ventes_'+index+'_tva').each(function(){


                                                        $(this).val(data.TVA).prop("selected", true);



                                                    });
                                                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                                        $(this).val(totalHT * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + totalHT);

                                                    });
                                                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                                        $(this).val(data.TTC * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + data.TTC );

                                                    });
                                                    $('#bls_ventes_'+index+'_description').each(function(){

                                                        $(this).val(data.description);

                                                    });







                                                    var sum = 0;
                                                    $(".totalHTa").each(function() {
                                                        sum += parseFloat(+this.value.replace(/ /g, ''));
                                                    });


                                                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));




                                                    var sumTTC = 0;
                                                    $(".totalTTCa").each(function() {
                                                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                                                    });
                                                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                                                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                                                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * data.totalHT /100 ;

                                                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (data.TTC - data.totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                                                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * data.totalHT /100 ;

                                                    $('#bls_ventes_'+index+'_puHTreduit').val(data.totalHT - valReduction  );



                                                    $('#bls_ventes_'+index+'_puTTCreduit').val((data.totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (data.totalHT - valReduction));


                                                    var sumReduction = 0;

                                                    $(".totalReduct").each(function() {
                                                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                                                    });
                                                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                                                    var sumtotalReduction = 0;

                                                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                                                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                                                    });
                                                    var sumtotalht = 0;
                                                    $(".totalhtr").each(function() {
                                                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                                                    });
                                                    var sumtotalttc = 0;
                                                    $(".totalttcr").each(function() {
                                                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                                                    });
                                                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                                                    $('#devis_totalHT').val(sumtotalht);
                                                    $('#devis_totalTTC').val(sumtotalttc);
                                                    $('#devis_totalReduction').val(sumReduction);
                                                    $('#indicator1').hide();
                                                    $('#devis_etat').change(function(){

                                                        if($('#devis_etat').val() == 'Payé'){
                                                            $('#devis_montantpaye').val(sumTTC)
                                                        }else {
                                                            $('#devis_montantpaye').val(null)
                                                        }

                                                    });




                                                }
                                            });

                                        });
                                        $('#indicator1').hide();

                                    },
                                    error: function() { // if error

                                    }
                                });



                            });
                            $('#indicator1').hide();
                        },
                        error: function() { // if error

                        }
                    });
                } else {
                    $('#match'+index).text(''); // If less than 2 characters, clear the <div id="match"></div>
                }

            });
            $('#bls_ventes_'+index+'_qte').keyup(function(){
                $('#indicator1').show();
                if($('#bls_ventes_'+index+'_puHT').val()){
                    puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                }else {
                    puHTVal = 1;
                }
                if($('#bls_ventes_'+index+'_prixHT').val()){
                    prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                }else {
                    prixHTVal = 1;
                }
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_bes_qte',{qte:$(this).val(), pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                    success: function (data) {
                        if(prixHTVal == 1){

                        }else {
                            $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                $(this).val(data.totalHTa.toFixed(2));

                            });

                            $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                $(this).val(data.TTC2.toFixed(2));

                            });
                        }
                        if(puHTVal == 1){

                        }else {
                            $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                $(this).val(data.TTC.toFixed(2));

                            });
                            $('#bls_ventes_'+index+'_totalHT').each(function(){

                                $(this).val(data.totalHT.toFixed(2));

                            });

                        }


                        var total = 0
                        var qte =0
                        $('.totalqt ').each(function(e){
                            $(this).attr('class', 'form-control totalqt  totalqt'+e);
                            if($(this).val() == $('#bls_aprofact_'+e+'_produits').val()) {

                                $(this).attr('class', 'form-control totalqt totalqt'+e);

                            }
                        });
                        $('.aproprod ').each(function(e){
                            $(this).attr('class', 'form-control aproprod  aproprod'+e);
                            if($(this).val() == $('#bls_aprofact_'+e+'_produits').val()) {

                                $(this).attr('class', 'form-control Valprod Valprod'+e);

                            }
                        });
                        $('.aproqte ').each(function(e){
                            $(this).attr('class', 'form-control aproqte  aproqte'+e);
                            if($(this).val() == $('#bls_aprofact_'+e+'_produits').val()) {

                                $(this).attr('class', 'form-control QTEapro QTEapro'+e);

                            }
                        });
                        $('.produits').each(function(e){



                            $(this).attr('class', 'form-control hidden prod prod'+e);


                        });
                        $('.QTE').each(function(e){



                                $(this).attr('class', 'form-control QTE QTE'+e);
                            var qte = 0;
                            $(".QTE"+index).each(function() {
                                qte += parseInt(+this.value);
                                console.log(qte);
                            });

                            console.log(qte);
                        });





                        var sum = 0;
                        $(".totalHTa").each(function() {
                            sum += parseInt(+this.value);
                        });
                        $('#sum_net').text(sum.toFixed(2));

                        var sumTVA = 0;
                        $(".TVA2").each(function() {
                            sumTVA += parseInt(+data.totalTVA2);
                        });
                        $('#sum_tva').text(sumTVA.toFixed(2));

                        var sumTTC = 0;
                        $(".totalTTCa").each(function() {
                            sumTTC += parseInt(+this.value);
                        });
                        $('#sum_ttc').text(sumTTC.toFixed(2));

                        var sumReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumReduction += parseFloat(+data.reduction);
                        });
                        $('#sum_discount').text(sumReduction.toFixed(2));

                        var sumtotalReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumtotalReduction += parseFloat(+data.totalReduction);
                        });
                        $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                        $('#indicator1').hide();
                    }

                });



            });

            $('#bls_ventes_'+index+'_prixHT').keyup(function(){
                $('#indicator1').show();
                if($('#bls_ventes_'+index+'_qte').val()){
                    qteVal = 1;
                }else {
                    qteVal = 1;
                }
                if($('#bls_ventes_'+index+'_puHT').val()){
                    puHTVal = 1;
                }else {
                    puHTVal = 1;
                }
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:$('#bls_ventes_'+index+'_prixHT').val(), tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                    success: function (data) {

                        $('#bls_ventes_'+index+'_prixTTC').each(function(){

                            $(this).val(data.TTC2.toFixed(2));

                        });

                        if($('#bls_ventes_'+index+'_qte').val()){

                            $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                $(this).val(data.totalHTa * $('#bls_ventes_'+index+'_qte').val());

                            });

                            $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                $(this).val(data.TTC2.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                            });

                        }



                        var sum = 0;
                        $(".totalHTa").each(function() {
                            sum += parseInt(+this.value);
                        });
                        $('#sum_net').text(sum.toFixed(2));

                        var sumTVA = 0;
                        $(".TVA2").each(function() {
                            sumTVA += parseInt(+data.totalTVA2);
                        });
                        $('#sum_tva').text(sumTVA.toFixed(2));

                        var sumTTC = 0;
                        $(".totalTTCa").each(function() {
                            sumTTC += parseInt(+this.value);
                        });
                        $('#sum_ttc').text(sumTTC.toFixed(2));

                        var sumReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumReduction += parseFloat(+data.reduction);
                        });
                        $('#sum_discount').text(sumReduction.toFixed(2));

                        var sumtotalReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumtotalReduction += parseFloat(+data.totalReduction);
                        });
                        $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                        $('#indicator1').hide();
                    }

                });



            });
            $('#bls_ventes_'+index+'_puHT').keyup(function(){
                $('#indicator1').show();
                if($('#bls_ventes_'+index+'_qte').val()){
                    qteVal = 1;
                }else {
                    qteVal = 1;
                }
                if($('#bls_ventes_'+index+'_prixHT').val()){
                    prixHTVal = 1;
                }else {
                    prixHTVal = 1;
                }
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:$('#bls_ventes_'+index+'_puHT').val(),pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                    success: function (data) {

                        $('#bls_ventes_'+index+'_puTTC').each(function(){

                            $(this).val(data.TTC.toFixed(2));

                        });

                        if($('#bls_ventes_'+index+'_qte').val()){

                            $('#bls_ventes_'+index+'_totalHT').each(function(){

                                $(this).val(data.totalHT.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                            });

                            $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                $(this).val(data.TTC.toFixed(2) * $('#bls_ventes_'+index+'_qte').val());

                            });

                        }
                        var sum = 0;
                        $(".totalHTa").each(function() {
                            sum += parseInt(+this.value);
                        });
                        $('#sum_net').text(sum.toFixed(2));

                        var sumTVA = 0;
                        $(".TVA2").each(function() {
                            sumTVA += parseInt(+data.totalTVA2);
                        });
                        $('#sum_tva').text(sumTVA.toFixed(2));

                        var sumTTC = 0;
                        $(".totalTTCa").each(function() {
                            sumTTC += parseInt(+this.value);
                        });
                        $('#sum_ttc').text(sumTTC.toFixed(2));

                        var sumReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumReduction += parseFloat(+data.reduction);
                        });
                        $('#sum_discount').text(sumReduction.toFixed(2));

                        var sumtotalReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumtotalReduction += parseFloat(+data.totalReduction);
                        });
                        $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                        $('#indicator1').hide();
                    }

                });



            });

            $('#bls_ventes_'+index+'_prixTTC').keyup(function(){



                var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 +1;


                $('#bls_ventes_'+index+'_prixHT').each(function(){
                    var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 +1;


                    var prixht= $('#bls_ventes_'+index+'_prixTTC').val() / TVA;

                    $(this).val(prixht.toFixed(2));

                });

                $('#bls_ventes_'+index+'_totalHTa').each(function(){

                    var totalHT = $('#bls_ventes_'+index+'_prixHT').val() * $('#bls_ventes_'+index+'_qte').val();
                    $(this).val(totalHT.toFixed(2));

                });

                $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                    var totalTTC = $('#bls_ventes_'+index+'_prixTTC').val() * $('#bls_ventes_'+index+'_qte').val();
                    $(this).val(totalTTC.toFixed(2));

                });

                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();
            });
            $('#bls_ventes_'+index+'_puTTC').keyup(function(){



                var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 +1;


                $('#bls_ventes_'+index+'_puHT').each(function(){
                    var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 +1;


                    var prixht= $('#bls_ventes_'+index+'_puTTC').val() / TVA;

                    $(this).val(prixht.toFixed(2));

                });

                $('#bls_ventes_'+index+'_totalHT').each(function(){

                    var totalHT = $('#bls_ventes_'+index+'_puHT').val() * $('#bls_ventes_'+index+'_qte').val();
                    $(this).val(totalHT.toFixed(2));

                });

                $('#bls_ventes_'+index+'_totalTTC').each(function(){

                    var totalTTC = $('#bls_ventes_'+index+'_puTTC').val() * $('#bls_ventes_'+index+'_qte').val();
                    $(this).val(totalTTC.toFixed(2));

                });

                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();
            });

            $('#bls_ventes_'+index+'_tva2').change(function(){
                $('#indicator1').show();
                if($('#bls_ventes_'+index+'_qte').val()){
                    qteVal = 1;
                }else {
                    qteVal = 1;
                }
                if($('#bls_ventes_'+index+'_puHT').val()){
                    puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                }else {
                    puHTVal = 1;
                }
                if($('#bls_ventes_'+index+'_prixHT').val()){
                    prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                }else {
                    prixHTVal = 1;
                }
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                    success: function (data) {
                        if(prixHTVal == 1){

                        }else {
                            $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                $(this).val(data.TTC2);

                            });
                            if($('#bls_ventes_'+index+'_qte').val()) {
                                $('#bls_ventes_' + index + '_totalTTCa').each(function () {

                                    $(this).val(data.TTC2 * $('#bls_ventes_' + index + '_qte').val());

                                });
                            }

                        }


                        var sum = 0;
                        $(".totalHTa").each(function() {
                            sum += parseInt(+this.value);
                        });
                        $('#sum_net').text(sum.toFixed(2));

                        var sumTVA = 0;
                        $(".TVA2").each(function() {
                            sumTVA += parseInt(+data.totalTVA2);
                        });
                        $('#sum_tva').text(sumTVA.toFixed(2));

                        var sumTTC = 0;
                        $(".totalTTCa").each(function() {
                            sumTTC += parseInt(+this.value);
                        });
                        $('#sum_ttc').text(sumTTC.toFixed(2));

                        var sumReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumReduction += parseFloat(+data.reduction);
                        });
                        $('#sum_discount').text(sumReduction.toFixed(2));

                        var sumtotalReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumtotalReduction += parseFloat(+data.totalReduction);
                        });
                        $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                        $('#indicator1').hide();
                    }

                });



            });
            $('#bls_ventes_'+index+'_tva').change(function(){
                $('#indicator1').show();
                if($('#bls_ventes_'+index+'_qte').val()){
                    qteVal = 1;
                }else {
                    qteVal = 1;
                }
                if($('#bls_ventes_'+index+'_puHT').val()){
                    puHTVal = $('#bls_ventes_'+index+'_puHT').val();
                }else {
                    puHTVal = 1;
                }
                if($('#bls_ventes_'+index+'_prixHT').val()){
                    prixHTVal = $('#bls_ventes_'+index+'_prixHT').val();
                }else {
                    prixHTVal = 1;
                }
                $.ajax({
                    type:'GET',
                    url: Routing.generate('admin_bes_qte',{qte:qteVal, pu:puHTVal,pua:prixHTVal, tva:$('#bls_ventes_'+index+'_tva option:selected').val(),tva2:$('#bls_ventes_'+index+'_tva2 option:selected').val()}),
                    success: function (data) {
                        if(prixHTVal == 1){

                        }else {
                            $('#bls_ventes_'+index+'_puTTC').each(function(){

                                $(this).val(data.TTC);

                            });
                            if($('#bls_ventes_'+index+'_qte').val()) {
                                $('#bls_ventes_' + index + '_totalTTC').each(function () {

                                    $(this).val(data.TTC2 * $('#bls_ventes_' + index + '_qte').val());

                                });
                            }

                        }
                        if(puHTVal == 1){

                        }else {

                            $('#bls_ventes_'+index+'_puTTC').each(function(){

                                $(this).val(data.TTC);

                            });

                            if($('#bls_ventes_'+index+'_qte').val()) {
                                $('#bls_ventes_' + index + '_totalTTC').each(function () {

                                    $(this).val(data.TTC * $('#bls_ventes_' + index + '_qte').val());

                                });
                            }

                        }

                        var sum = 0;
                        $(".totalHTa").each(function() {
                            sum += parseInt(+this.value);
                        });
                        $('#sum_net').text(sum.toFixed(2));

                        var sumTVA = 0;
                        $(".TVA2").each(function() {
                            sumTVA += parseInt(+data.totalTVA2);
                        });
                        $('#sum_tva').text(sumTVA.toFixed(2));

                        var sumTTC = 0;
                        $(".totalTTCa").each(function() {
                            sumTTC += parseInt(+this.value);
                        });
                        $('#sum_ttc').text(sumTTC.toFixed(2));

                        var sumReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumReduction += parseFloat(+data.reduction);
                        });
                        $('#sum_discount').text(sumReduction.toFixed(2));

                        var sumtotalReduction = 0;
                        $(".REDUCTION").each(function() {
                            sumtotalReduction += parseFloat(+data.totalReduction);
                        });
                        $('#sum_after_discount').text(sumtotalReduction.toFixed(2));
                        $('#indicator1').hide();
                    }

                });



            });

            $('#bls_ventes_'+index+'_totalHTa').keyup(function(){
                $('#indicator1').hide();
                if($('#bls_ventes_'+index+'_reduction').val()){
                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                }else {
                    reductionVal = 0;
                }

                var totalHT = $('#bls_ventes_'+index+'_totalHTa').val() * $('#bls_ventes_'+index+'_qte').val();

                var TVA = $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 ;

                var TTC = totalHT * TVA + totalHT;

                var totalTVA = totalHT * TVA;
                totalttc = $('#bls_ventes_'+index+'_totalTTCa').val();
                totalht = $('#bls_ventes_'+index+'_totalHTa').val();
                tvaval= ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100)+1;



                $('#bls_ventes_'+index+'_totalTTCa').val( (TTC/$('#bls_ventes_'+index+'_qte').val()).toFixed(2) );
                var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                $('#bls_ventes_'+index+'_prixTTC').each(function(){

                    $(this).val( ttca.toFixed(2) );

                });
                if($('#bls_ventes_'+index+'_qte').val() >= 1){
                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                        $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                    });
                    $('#bls_ventes_'+index+'_prixHT').each(function(){
                        totalpu = $('#bls_ventes_'+index+'_totalHTa').val() / $('#bls_ventes_'+index+'_qte').val();

                        $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHTa').each(function(){
                        totalht =  $(this).val();

                        $(this).val();

                    });
                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                        $(this).val();

                    });

                    $('#bls_ventes_'+index+'_tva2').each(function(){

                        $(this).attr('value',totalTVA2);


                    });
                    $('#bls_ventes_'+index+'_tva2').change(function(){

                        $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));


                    });
                }else {


                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                        $(this).val(totalHTa.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHTa').each(function(){

                        $(this).val(TTCa.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_tva2').each(function(){

                        $(this).attr('value',totalTVA);


                    });

                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });

                    var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_prixTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                }


                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();

            });
            $('#bls_ventes_'+index+'_totalTTCa').keyup(function(){
                $('#indicator1').hide();
                if($('#bls_ventes_'+index+'_reduction').val()){
                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                }else {
                    reductionVal = 0;
                }
                var totalHT = $('#bls_ventes_'+index+'_totalHTa').val() * $('#bls_ventes_'+index+'_qte').val();

                var TVA = ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100) ;

                var TTC = totalHT * TVA + totalHT;

                var totalTVA = totalHT * TVA;

                totalttc = $('#bls_ventes_'+index+'_totalTTCa').val();
                totalht = $('#bls_ventes_'+index+'_totalHTa').val();
                tvaval= ($('#bls_ventes_'+index+'_tva2 option:selected').text() / 100)+1;


                $('#bls_ventes_'+index+'_totalHTa').val( (totalttc  / tvaval).toFixed(2) );
                $('#bls_ventes_'+index+'_prixHT').val($('#bls_ventes_'+index+'_totalHTa').val());


                if($('#bls_ventes_'+index+'_qte').val() >= 1){
                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                        $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                    });
                    $('#bls_ventes_'+index+'_prixHT').each(function(){
                        totalpu = $('#bls_ventes_'+index+'_totalHTa').val() / $('#bls_ventes_'+index+'_qte').val();

                        $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHTa').each(function(){
                        totalht =  $(this).val();

                        $(this).val();

                    });
                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                        $(this).val();

                    })



                    $('#bls_ventes_'+index+'_tva2').each(function(){

                        $(this).attr('value',totalTVA);


                    });
                    $('#bls_ventes_'+index+'_tva2').change(function(){

                        $('#bls_ventes_'+index+'_prixHT').val(totalpu.toFixed(2));


                    });


                    var ttca = $('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_prixTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                }else {


                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                        $(this).val(totalHT.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHTa').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_tva2').each(function(){

                        $(this).attr('value',totalTVA);


                    });

                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });


                }



                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * $('#bls_ventes_'+index+'_totalTTCa').val() /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva2 option:selected').text()/100) + (totalHTa - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();


            });

            $('#bls_ventes_'+index+'_totalHT').keyup(function(){
                $('#indicator1').hide();
                if($('#bls_ventes_'+index+'_reduction').val()){
                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                }else {
                    reductionVal = 0;
                }

                var totalHT = $('#bls_ventes_'+index+'_totalHT').val() * $('#bls_ventes_'+index+'_qte').val();

                var TVA = $('#bls_ventes_'+index+'_tva option:selected').text() / 100 ;

                var TTC = totalHT * TVA + totalHT;

                var totalTVA = totalHT * TVA;
                totalttc = $('#bls_ventes_'+index+'_totalTTC').val();
                totalht = $('#bls_ventes_'+index+'_totalHT').val();
                tvaval= ($('#bls_ventes_'+index+'_tva option:selected').text() / 100)+1;



                $('#bls_ventes_'+index+'_totalTTC').val( (TTC/$('#bls_ventes_'+index+'_qte').val()).toFixed(2) );
                var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                $('#bls_ventes_'+index+'_puTTC').each(function(){

                    $(this).val( ttca.toFixed(2) );

                });
                if($('#bls_ventes_'+index+'_qte').val() >= 1){
                    $('#bls_ventes_'+index+'_puHT').each(function(){

                        $(this).val($('#bls_ventes_'+index+'_totalTTCa').val() / $('#bls_ventes_'+index+'_qte').val() );

                    });
                    $('#bls_ventes_'+index+'_puHT').each(function(){
                        totalpu = $('#bls_ventes_'+index+'_totalHT').val() / $('#bls_ventes_'+index+'_qte').val();

                        $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHT').each(function(){
                        totalht =  $(this).val();

                        $(this).val();

                    });
                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                        $(this).val();

                    });

                    $('#bls_ventes_'+index+'_tva').each(function(){

                        $(this).attr('value',totalTVA2);


                    });
                    $('#bls_ventes_'+index+'_tva').change(function(){

                        $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));


                    });
                }else {


                    $('#bls_ventes_'+index+'_puHT').each(function(){

                        $(this).val(totalHTa.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHT').each(function(){

                        $(this).val(TTCa.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_tva').each(function(){

                        $(this).attr('value',totalTVA);


                    });

                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });

                    var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_puTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                }


                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (totalHT - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();

            });
            $('#bls_ventes_'+index+'_totalTTC').keyup(function(){
                $('#indicator1').hide();
                if($('#bls_ventes_'+index+'_reduction').val()){
                    reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                }else {
                    reductionVal = 0;
                }
                var totalHT = $('#bls_ventes_'+index+'_totalHT').val() * $('#bls_ventes_'+index+'_qte').val();

                var TVA = ($('#bls_ventes_'+index+'_tva option:selected').text() / 100) ;

                var TTC = totalHT * TVA + totalHT;

                var totalTVA = totalHT * TVA;

                totalttc = $('#bls_ventes_'+index+'_totalTTC').val();
                totalht = $('#bls_ventes_'+index+'_totalHT').val();
                tvaval= ($('#bls_ventes_'+index+'_tva option:selected').text() / 100)+1;


                $('#bls_ventes_'+index+'_totalHT').val( (totalttc  / tvaval).toFixed(2) );
                $('#bls_ventes_'+index+'_puHT').val($('#bls_ventes_'+index+'_totalHT').val());


                if($('#bls_ventes_'+index+'_qte').val() >= 1){
                    $('#bls_ventes_'+index+'_puHT').each(function(){

                        $(this).val($('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val() );

                    });
                    $('#bls_ventes_'+index+'_puHT').each(function(){
                        totalpu = $('#bls_ventes_'+index+'_totalHT').val() / $('#bls_ventes_'+index+'_qte').val();

                        $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHT').each(function(){
                        totalht =  $(this).val();

                        $(this).val();

                    });
                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                        $(this).val();

                    })



                    $('#bls_ventes_'+index+'_tva').each(function(){

                        $(this).attr('value',totalTVA);


                    });
                    $('#bls_ventes_'+index+'_tva').change(function(){

                        $('#bls_ventes_'+index+'_puHT').val(totalpu.toFixed(2));


                    });


                    var ttca = $('#bls_ventes_'+index+'_totalTTC').val() / $('#bls_ventes_'+index+'_qte').val();
                    $('#bls_ventes_'+index+'_puTTC').each(function(){

                        $(this).val( ttca.toFixed(2) );

                    });
                }else {


                    $('#bls_ventes_'+index+'_puHT').each(function(){

                        $(this).val(totalHT.toFixed(2));

                    });
                    $('#bls_ventes_'+index+'_totalHT').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });

                    $('#bls_ventes_'+index+'_tva').each(function(){

                        $(this).attr('value',totalTVA);


                    });

                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                        $(this).val(TTC.toFixed(2));

                    });


                }



                var sum = 0;
                $(".totalHTa").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));



                var sumTTC = 0;
                $(".totalTTCa").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                valReduction = $('#bls_ventes_'+index+'_reduction').val() * $('#bls_ventes_'+index+'_totalTTCa').val() /100 ;

                $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (TTC - totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * totalHT /100 ;

                $('#bls_ventes_'+index+'_puHTreduit').val(totalHT - valReduction  );



                $('#bls_ventes_'+index+'_puTTCreduit').val((totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva2 option:selected').text()/100) + (totalHTa - valReduction));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                var sumtotalReduction = 0;

                $('#bls_ventes_'+index+'_totalreduct').each(function() {
                    sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                });
                var sumtotalht = 0;
                $(".totalhtr").each(function() {
                    sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                });
                var sumtotalttc = 0;
                $(".totalttcr").each(function() {
                    sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                $('#depenses_totalHT').val(sumtotalht);
                $('#depenses_totalTTC').val(sumtotalttc);
                $('#depenses_totalReduction').val(sumReduction);
                $('#indicator1').hide();


            });
            $( 'a#autocomplete_arrow'+index ).click(function() {
                $('#bls_ventes_'+index+'_reduction').val(0);
                var input = $(this).val(); // We take the input value

                $('#indicator1').show();// Loader icon apprears in the <div id="match"></div>
                var data = {input: input}; // We pass input argument in Ajax
                $.ajax({
                    type: "POST",
                    url: ROOT_URL , // call the php file ajax/tuto-autocomplete.php (check the routine we defined)
                    data: data, // Send dataFields var
                    dataType: 'json', // json method
                    timeout: 3000,
                    success: function(response){ // If success
                        $('#match'+index).html(response.countryList); // Return data (UL list) and insert it in the <div id="match"></div>
                        $('#matchList li').on('click', function() { // When click on an element in the list
                            $('#bls_ventes_'+index+'_name').val($(this).attr('id')); // Update the field with the new element
                            $('#match'+index).text(''); // Clear the <div id="match"></div>
                            if($('#bls_ventes_'+index+'_reduction').val()){
                                reductionVal = $('#bls_ventes_'+index+'_reduction').val();
                            }else {
                                reductionVal = 0;
                            }

                            $.ajax({
                                type:'GET',
                                url: Routing.generate('admin_depenses_prod',{prod:$(this).attr('value'), qte:$('#bls_ventes_'+index+'_qte').val(), tva2:$('#bls_ventes_'+index+'_tva2 option:selected').text(), tva:$('#bls_ventes_'+index+'_tva option:selected').text(),reduction:reductionVal}),
                                success: function (data) {

                                    var totalHT = data.puAchat * $('#bls_ventes_'+index+'_qte').val();

                                    $('#bls_ventes_'+index+'_produits').each(function(){

                                        $(this).val(data.pid).prop("selected", true);

                                    });

                                    $('#bls_ventes_'+index+'_reference').each(function(){

                                        $(this).val(data.reference);

                                    });
                                    $('#bls_ventes_'+index+'_unite').each(function(){

                                        $(this).val(data.unite);


                                    });
                                    $('#bls_ventes_'+index+'_prixHT').each(function(){

                                        $(this).val(data.puAchat);

                                    });
                                    $('#bls_ventes_'+index+'_puHT').each(function(){

                                        $(this).val(data.puHT);

                                    });
                                    $('#bls_ventes_'+index+'_puTTC').each(function(){

                                        $(this).val(data.puTTC);

                                    });
                                    $('#bls_ventes_'+index+'_prixTTC').each(function(){

                                        $(this).val(data.puTTCa);

                                    });

                                    $('#bls_ventes_'+index+'_totalHTa').each(function(){

                                        $(this).val(data.totalHTa);


                                    });
                                    $('#bls_ventes_'+index+'_totalHT').each(function(){

                                        $(this).val(data.totalHT);


                                    });

                                    $('#bls_ventes_'+index+'_tva2').each(function(){

                                        $(this).val(data.TVAprod).prop("selected", true);

                                    });
                                    $('#bls_ventes_'+index+'_tva').each(function(){


                                        $(this).val(data.TVA).prop("selected", true);


                                    });

                                    $('#bls_ventes_'+index+'_totalTTCa').each(function(){

                                        $(this).val(totalHT * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + totalHT);

                                    });
                                    $('#bls_ventes_'+index+'_totalTTC').each(function(){

                                        $(this).val(data.TTC * $('#bls_ventes_'+index+'_tva2 option:selected').text() / 100 + data.TTC );

                                    });
                                    $('#bls_ventes_'+index+'_description').each(function(){

                                        $(this).val(data.description);

                                    });


                                    $('.aprofact').each(function(i){
                                         qteapro = $('#bls_aprofact_'+i+'_qte').val();
                                         qte = $('#bls_ventes_'+index+'_qte').val();
                                         total = parseInt(qte) + parseInt(qteapro);

                                        if($('#bls_ventes_'+index+'_produits').val() == $('#bls_aprofact_'+i+'_produits').val()){





                                            $('#bls_aprofact_'+i+'_qte').val(total);
                                        }

                                    });







                                    var sum = 0;
                                    $(".totalHTa").each(function() {
                                        sum += parseFloat(+this.value.replace(/ /g, ''));
                                    });


                                    $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ","));




                                    var sumTTC = 0;
                                    $(".totalTTCa").each(function() {
                                        sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                                    });
                                    $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                                    $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                                    valReduction = $('#bls_ventes_'+index+'_reduction').val() * data.totalHT /100 ;

                                    $('#bls_ventes_'+index+'_totalreduct').val(valReduction + (data.TTC - data.totalHT) /100 * $('#bls_ventes_'+index+'_reduction').val());

                                    puHTreduit = $('#bls_ventes_'+index+'_puHTreduit').val() * data.totalHT /100 ;

                                    $('#bls_ventes_'+index+'_puHTreduit').val(data.totalHT - valReduction  );



                                    $('#bls_ventes_'+index+'_puTTCreduit').val((data.totalHT - valReduction) * ($('#bls_ventes_'+index+'_tva option:selected').text()/100) + (data.totalHT - valReduction));


                                    var sumReduction = 0;

                                    $(".totalReduct").each(function() {
                                        sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                                    });
                                    $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );



                                    var sumtotalReduction = 0;

                                    $('#bls_ventes_'+index+'_totalreduct').each(function() {
                                        sumtotalReduction += parseFloat(+ sumTTC - sumReduction  );
                                    });
                                    var sumtotalht = 0;
                                    $(".totalhtr").each(function() {
                                        sumtotalht += parseFloat(+this.value.replace(/ /g, ''));
                                    });
                                    var sumtotalttc = 0;
                                    $(".totalttcr").each(function() {
                                        sumtotalttc += parseFloat(+this.value.replace(/ /g, ''));
                                    });
                                    $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );

                                    $('#devis_totalHT').val(sumtotalht);
                                    $('#devis_totalTTC').val(sumtotalttc);
                                    $('#devis_totalReduction').val(sumReduction);
                                    $('#indicator1').hide();
                                    $('#devis_etat').change(function(){

                                        if($('#devis_etat').val() == 'Payé'){
                                            $('#devis_montantpaye').val(sumTTC)
                                        }else {
                                            $('#devis_montantpaye').val(null)
                                        }

                                    });




                                }
                            });

                        });
                        $('#indicator1').hide();

                    },
                    error: function() { // if error

                    }
                });

            });












            $('#depenses_etat').change(function(){

                if($('#depenses_etat').val() == 'Payé'){
                    $('#depenses_montantpaye').val(accounting.formatMoney($('#bls_ventes_'+index+'_puTTCreduit').val(), "", 2, " ", ","))
                }else {
                    $('#depenses_montantpaye').val(null)
                }

            });


        }

        function addTagFormDeleteLink($tagFormLi) {

            var $removeFormA = $('<a class="del"><i class="fa fa-close" aria-hidden="true" style=""></i></a>');
            $tagFormLi.append($removeFormA);

            $removeFormA.on('click', function(e) {

                // prevent the link from creating a "#" on the URL
                e.preventDefault();

                // remove the li for the tag form
                $tagFormLi.remove().fadeOut('speed');



                var total = 0
                var qte =0
                $('.QTE').each(function(i){
                    $('.aprofactqte').attr('class', 'totalqt aprofactqte aprofactqte'+i);
                    $('.aproqte').attr('class', 'aproqte aprofactqte'+i);

                    qteapro = $('#bls_aprofact_'+i+'_qte').val();
                    qte += parseInt(+$(this).val());
                    qtedefault = $('.aprofactqte'+$('#bls_ventes_'+i+'_produits').val()).val(qte);
                    total = parseInt(qte) ;



                    if($('#bls_ventes_'+i+'_produits').val() == $('#bls_aprofact_'+i+'_produits').val()){



                        $('.aprofactqte'+i).val(qte);



                    }

                });



                var sum = 0;
                $(".totalHT").each(function() {
                    sum += parseFloat(+this.value.replace(/ /g, ''));
                });


                $('#sum_net').text(accounting.formatMoney(sum , "", 2, " ", ",")).number( true, 2, ',', ' ' );



                var sumTTC = 0;
                $(".totalTTC").each(function() {
                    sumTTC += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_ttc').text(accounting.formatMoney(sumTTC, "", 2, " ", ","));


                $('#sum_tva').text(accounting.formatMoney(sumTTC - sum, "", 2, " ", ","));


                var sumReduction = 0;

                $(".totalReduct").each(function() {
                    sumReduction += parseFloat(+this.value.replace(/ /g, ''));
                });
                $('#sum_discount').text(accounting.formatMoney(sumReduction, "", 2, " ", ",") );





                sumtotalReduction = sumTTC - sumReduction ;

                $('#sum_after_discount').text(accounting.formatMoney(sumtotalReduction, "", 2, " ", ",") );
                $('#indicator1').hide();




            });

        }


        $('#depenses_type').change(function () {

            if (  this.value == 'fact' ) {
                window.location = "{{ path('admin_depenses_new') }}";
            }
            if (  this.value == 'proforma' ) {
                window.location ="{{ path('admin_proformas_new') }}";
            }
            if (  this.value == 'recu' ) {
                window.location = "{{ path('admin_recus_new') }}";
            }


            if (  this.value == 'devis' ) {
                window.location = "{{ path('admin_devis_new') }}";
            }

            if (  this.value == 'bdc' ) {
                window.location = "{{ path('admin_bdc_new') }}";
            }


        });

        $(document).mouseup(function (e) {
            var popup = $(".ui-autocomplete");
            if (!$('#matchList').is(e.target) && !popup.is(e.target) && popup.has(e.target).length == 0) {
                popup.hide(500);
            }
        });

    </script>

{% endblock %}



